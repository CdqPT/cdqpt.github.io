---
title: 硕论-四度检测及报警
date: 2019-02-05
categories:
- 笔记
tags:
- 硕论
toc: true
img: /medias/paperimg/paper.jpg
---

使用Arduino检测**温度**，**湿度**，**烟雾**以及**气压**的度数在1602显示屏和串口上显示，并提供超阈值报警功能。<!-- more -->

使用定时器中断函数需要调用MsTimer2库，并在程序中引用头文件 MsTimer2.h。MsTimer2库下载地址：[https://github.com/PaulStoffregen/MsTimer2](https://github.com/PaulStoffregen/MsTimer2)

下载后放入C:\Program Files (x86)\Arduino\libraries即可。

说明：头文件中分号“”和尖括号<>的区别。

>分号“”是从当前自建的工程文件夹里搜索头文件，尖括号<>是从安装目录的库文件里搜索头文件。

```C++
/********************************************
 * 数据中心机房巡检机器人四度传感器说明
 * 1602LCD液晶显示屏：
 *         SDA  A4
 *         SCL  A5
 * DHT11温湿度传感器：
 *         OUT  7
 * MQ-2烟雾传感器：
 *         AO   A0
 *BMP180气压传感器：
 *         SDA  A4
 *         SCL  A5
 *有源蜂鸣器：
 *         I/O  8
****************************************** */

//*************************************************************************************
//***************************定义及初始化**********************************************
//*************************************************************************************
#include "dht.h" 
#include "SFE_BMP180.h"
#include <LiquidCrystal_I2C.h>//1602液晶屏函数库
#include <Wire.h> //IIC函数库
#include <MsTimer2.h>     //定时器库的头文件

//*************************************************************************************
//***************************以下是定义*******************************************
//*************************************************************************************
LiquidCrystal_I2C lcd(0x27,16,2);  // 设置LCD起始地址为0x27，16个字符，两行显示。经测试起始地址不能改啊。。
dht DHT;//创造一个dht类,用于存放温湿度数据
SFE_BMP180 pressure;
double P,T;
char status;//定义气压传感器参数
int gas;//定义烟雾传感器
const int DHT11_PIN= 7;//温湿度传感器引脚为7
int buzzerPin =8;//蜂鸣器引脚
const int analogPin=A0; //定义烟雾传感器引脚 

//*************************************************************************************
//***************************以下是定时器中断服务程序**********************************
//*************************************************************************************
void onTimer()
{
   if(DHT.temperature<100|DHT.humidity>100|P>100|gas>100)//设置温度值，高温报警，还可添加或功能并排检测
  { 
   
   digitalWrite(buzzerPin,LOW);//蜂鸣器报警，可以调节音调对不同的检测值报警音调不同。
   delay(50000);
   digitalWrite(buzzerPin,HIGH);
  }
    else
 {
      digitalWrite(buzzerPin,HIGH);
  }
}

//*************************************************************************************
//***************************以下是初始化程序*******************************************
//*************************************************************************************
void setup()
{
  Serial.begin(9600);//初始化串口
  MsTimer2::set(1000, onTimer); //设置中断，每1000ms进入一次中断服务程序 onTimer()
  MsTimer2::start(); //开始计时
  lcd.init();  //初始化lcd
  lcd.backlight();  //打开背光
  pinMode(buzzerPin,OUTPUT);//设置蜂鸣器为输出
  digitalWrite(buzzerPin,HIGH);//初始化蜂鸣器为高电平，不响
  //初始化气压传感器，一定要有的程序
  if (pressure.begin())
    Serial.println("BMP180 init success");
  else
  {
    // Oops, something went wrong, this is usually a connection problem,
    // see the comments at the top of this sketch for the proper connections.

    Serial.println("BMP180 init fail\n\n");
    while(1); // Pause forever.
  }
}
//*************************************************************************************
//***************************以下主程序循环*******************************************
//*************************************************************************************
void loop()
{
  //****************************************以下是温湿度传感器1，2********************************************//
        D: int chk = DHT.read11(DHT11_PIN);//读取温湿度值
          switch (chk)
          {
          case DHTLIB_OK:  
            //Serial.println("OK!"); 
            break;
          case DHTLIB_ERROR_CHECKSUM: 
            //goto D;
            //Serial.print("Checksum error,\t"); 
            break;
          case DHTLIB_ERROR_TIMEOUT: 
              goto D;
            //Serial.print("Time out error,\t"); 
            break;
          default: 
             // goto D;
            //Serial.print("Unknown error,\t"); 
            break;
          }
          
          // 显示数据
          lcd.setCursor(0, 0);//设置光标位置
          //输出温度值
          lcd.print("Tem:");//输出Tem：字符
          Serial.print("Tem:");
          lcd.print(DHT.temperature,1); //输出温度值
          Serial.print(DHT.temperature,1);
          lcd.print(char(223));//输出" ° "符号
          Serial.print(char(223));
          lcd.print("C");//输出C符号
          Serial.println(" C");
          
          //输出湿度值
          lcd.setCursor(0, 1);//设置光标位置
          lcd.print("Hum:");
          Serial.print("Hum:");
          lcd.print(DHT.humidity,1); //print the humidity on lcd
          Serial.print(DHT.humidity,1);
          lcd.print(" %"); 
          Serial.println(" %");
          delay(4000);
        
          lcd.clear();//清屏，为下一次显示做准备。


//***************************以下是气压传感器3*******************************************
// 开始测量气压:
// 参数可以设置从0-3 (highest res, longest wait).
// If request is successful, the number of ms to wait is returned.
// If request is unsuccessful, 0 is returned.

      status = pressure.startPressure(3);
      if (status != 0)
      {
          // Wait for the measurement to complete:
          delay(status);
  
          // Retrieve the completed pressure measurement:
          // Note that the measurement is stored in the variable P.
          // Note also that the function requires the previous temperature measurement (T).
          // (If temperature is stable, you can do one temperature measurement for a number of pressure measurements.)
          // Function returns 1 if successful, 0 if failure.
  
          status = pressure.getPressure(P,T);
          if (status != 0)
          {
            // Print out the measurement:
            Serial.print("pressure: ");
            Serial.print(P/10,2);
            Serial.println(" Kpa ");
            Serial.print("          ");
            Serial.print(P*0.0295301,2); //To convert millibars to inches of mercury
            Serial.print(" inches ");
            Serial.println(" "); //
            Serial.println(" "); // skipping 3 lines for easier reading
            Serial.println(" "); //
              lcd.setCursor(0, 0);//设置光标位置
              lcd.print("Pre:");//输出Tem：字符
              lcd.print(P/10,1); //输出温度值
              lcd.print("Kpa");//输出" mb "符号
            // The pressure sensor returns abolute pressure, which varies with altitude.
            // To remove the effects of altitude, use the sealevel function and your current altitude.
            // This number is commonly used in weather reports.
            // Parameters: P = absolute pressure in mb, ALTITUDE = current altitude in m.
            // Result: p0 = sea-level compensated pressure in mb
          }
          else Serial.println("error retrieving pressure measurement\n");
      }

//****************************************以下是烟雾传感器4********************************************//
//正常情况下45不会报警，超出45会报警
 
        gas=analogRead(analogPin);
        Serial.println(gas,DEC);
        lcd.setCursor(0, 1);//设置光标位置
        lcd.print("Gas:");//输出Tem：字符
        lcd.print(gas,1); //输出温度值
        lcd.print("ppm");//输出" mb "符号

        delay(4000);
        
        lcd.clear();
}
```