<!DOCTYPE HTML>
<html lang="zh-CN">






<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="C++å¤šçº¿ç¨‹, é™ˆå¾·å¼º ALaDing å†…è’™å¤å·¥ä¸šå¤§å­¦ æœºå™¨äºº ä¸œè½¯ ä¸œè½¯é›†å›¢ åµŒå…¥å¼ è‡ªåŠ¨é©¾é©¶ ADASIS">
    <meta name="description" content="C++11 æ–°æ ‡å‡†ä¸­å¼•å…¥äº†å››ä¸ªå¤´æ–‡ä»¶æ¥æ”¯æŒå¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œä»–ä»¬åˆ†åˆ«æ˜¯&amp;lt;atomic&amp;gt; ,&amp;lt;thread&amp;gt;,&amp;lt;mutex&amp;gt;,&amp;lt;condition_variable&amp;gt;å’Œ&amp;lt;future&amp;gt;ã€‚
">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>C++å¤šçº¿ç¨‹ | ALaDing</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
        code[class*="language-"], pre[class*="language-"] {
            white-space: pre !important;
        }
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>



  <link rel="amphtml" href="https://purethought.cn/9f089854.html/amp/index.html">

    
<link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>






<body style="overflow-x:hidden">
    <header id="navControl" class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">ALaDing</span>
                </a>
            </div>
            



<!-- <a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>é¦–é¡µ</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/dictionary" class="waves-effect waves-light">
            
            <i class="fa fa-book"></i>
            
            <span>å­—å…¸</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>åˆ†ç±»</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-heart"></i>
            
            <span>è±†ç“£</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-leaf"></i>
            
            <span>å…³äº</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-commenting"></i>
            
            <span>ç•™è¨€</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="æœç´¢"></i>
        </a>
    </li>
</ul> -->

<!-- æ”¯æŒäºŒçº§èœå•ç‰¹æ€§  -->
<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse">
  <i class="fa fa-navicon" >
     <b>å¯¼èˆª </b>
  </i>
</a>

<ul class="right nav-menu">
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/" class="waves-effect waves-light">
              
                <i class="fa fa-home"></i>
              
              <span>é¦–é¡µ</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/dictionary" class="waves-effect waves-light">
              
                <i class="fa fa-book"></i>
              
              <span>å­—å…¸</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories" class="waves-effect waves-light">
                
                  <i class="fa fa-bookmark"></i>
                
                <span>åˆ†ç±»</span>
                <i class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="https://purethought.cn/categories/%E7%AC%94%E8%AE%B0/" >
                    
                      <i class="fa fa-bookmark" style="margin-top: -20px;"></i>
                    
                    <span>ç¼–ç¨‹ç¬”è®°</span>
                  </a>
                </li>
              
                <li> 
                  <a href="https://purethought.cn/categories/%E6%96%87%E5%8F%B2%E5%93%B2/" >
                    
                      <i class="fa fa-bookmark" style="margin-top: -20px;"></i>
                    
                    <span>æ–‡å²å“²ç†</span>
                  </a>
                </li>
              
                <li> 
                  <a href="https://purethought.cn/categories/%E6%8A%95%E8%B5%84%E7%90%86%E8%B4%A2/" >
                    
                      <i class="fa fa-bookmark" style="margin-top: -20px;"></i>
                    
                    <span>æŠ•èµ„ç†è´¢</span>
                  </a>
                </li>
              
                <li> 
                  <a href="https://purethought.cn/categories/%E9%9A%8F%E7%AC%94/" >
                    
                      <i class="fa fa-bookmark" style="margin-top: -20px;"></i>
                    
                    <span>è¿‡ç¨‹éšç¬”</span>
                  </a>
                </li>
              
                <li> 
                  <a href="https://purethought.cn/categories/%E4%BC%98%E5%8C%96/" >
                    
                      <i class="fa fa-bookmark" style="margin-top: -20px;"></i>
                    
                    <span>æ—¢æœ‰ä¼˜åŒ–</span>
                  </a>
                </li>
              
                <li> 
                  <a href="https://purethought.cn/categories/%E6%95%99%E7%A8%8B/" >
                    
                      <i class="fa fa-bookmark" style="margin-top: -20px;"></i>
                    
                    <span>å®‰è£…æ•™ç¨‹</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/" class="waves-effect waves-light">
                
                  <i class="fa fa-heart"></i>
                
                <span>è±†ç“£</span>
                <i class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/books" >
                    
                      <i class="fa fa-book" style="margin-top: -20px;"></i>
                    
                    <span>ä¹¦å•</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/movies" >
                    
                      <i class="fa fa-film" style="margin-top: -20px;"></i>
                    
                    <span>ç”µå½±</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/games" >
                    
                      <i class="fa fa-gamepad" style="margin-top: -20px;"></i>
                    
                    <span>æ¸¸æˆ</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/" class="waves-effect waves-light">
                
                  <i class="fa fa-leaf"></i>
                
                <span>å…³äº</span>
                <i class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/about" >
                    
                      <i class="fa fa-user" style="margin-top: -20px;"></i>
                    
                    <span>ç®€ä»‹</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/galleries" >
                    
                      <i class="fa fa-camera" style="margin-top: -20px;"></i>
                    
                    <span>ç›¸å†Œ</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/friends" >
                    
                      <i class="fa fa-handshake-o" style="margin-top: -20px;"></i>
                    
                    <span>å‹é“¾</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/log" >
                    
                      <i class="fa fa-pencil-square-o" style="margin-top: -20px;"></i>
                    
                    <span>æ—¥å¿—</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/tags" >
                    
                      <i class="fa fa-tags" style="margin-top: -20px;"></i>
                    
                    <span>æ ‡ç­¾</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/archives" >
                    
                      <i class="fa fa-archive" style="margin-top: -20px;"></i>
                    
                    <span>å½’æ¡£</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/contact" class="waves-effect waves-light">
              
                <i class="fa fa-commenting"></i>
              
              <span>ç•™è¨€</span>
            </a>

            
      </li>
    

    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">

            <i id="searchIcon" class="fa fa-search" title="æœç´¢" >
              <b>æœç´¢ </b>
            </i>

        </a>
    </li>

</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">ALaDing</div>
        <div class="logo-desc">
            
            ä¸œè½¯é›†å›¢ | å†…è’™å¤å·¥ä¸šå¤§å­¦ | åµŒå…¥å¼å·¥ç¨‹å¸ˆ | ADAS
            
        </div>
    </div>

    


 <ul class="menu-list mobile-menu-list">  <li class="m-nav-item">  <a href="/" class="waves-effect waves-light">  <i class="fa fa-fw fa-home"></i>  é¦–é¡µ </a>  </li>  <li class="m-nav-item">  <a href="/dictionary" class="waves-effect waves-light">  <i class="fa fa-fw fa-book"></i>  å­—å…¸ </a>  </li>  <li class="m-nav-item">  <a href="javascript:;">  <i class="fa fa-fw fa-bookmark"></i>  åˆ†ç±» <span class="m-icon"><i class="fa fa-chevron-right"></i></span> </a> <ul>  <li> <a href="https://purethought.cn/categories/%E7%AC%94%E8%AE%B0/" >  <i class="fa fa-bookmark" style="left: 25px; position: absolute;"></i>  <span>ç¼–ç¨‹ç¬”è®°</span> </a> </li>  <li> <a href="https://purethought.cn/categories/%E6%96%87%E5%8F%B2%E5%93%B2/" >  <i class="fa fa-bookmark" style="left: 25px; position: absolute;"></i>  <span>æ–‡å²å“²ç†</span> </a> </li>  <li> <a href="https://purethought.cn/categories/%E6%8A%95%E8%B5%84%E7%90%86%E8%B4%A2/" >  <i class="fa fa-bookmark" style="left: 25px; position: absolute;"></i>  <span>æŠ•èµ„ç†è´¢</span> </a> </li>  <li> <a href="https://purethought.cn/categories/%E9%9A%8F%E7%AC%94/" >  <i class="fa fa-bookmark" style="left: 25px; position: absolute;"></i>  <span>è¿‡ç¨‹éšç¬”</span> </a> </li>  <li> <a href="https://purethought.cn/categories/%E4%BC%98%E5%8C%96/" >  <i class="fa fa-bookmark" style="left: 25px; position: absolute;"></i>  <span>æ—¢æœ‰ä¼˜åŒ–</span> </a> </li>  <li> <a href="https://purethought.cn/categories/%E6%95%99%E7%A8%8B/" >  <i class="fa fa-bookmark" style="left: 25px; position: absolute;"></i>  <span>å®‰è£…æ•™ç¨‹</span> </a> </li>  </ul>  </li>  <li class="m-nav-item">  <a href="javascript:;">  <i class="fa fa-fw fa-heart"></i>  è±†ç“£ <span class="m-icon"><i class="fa fa-chevron-right"></i></span> </a> <ul>  <li> <a href="/books" >  <i class="fa fa-book" style="left: 25px; position: absolute;"></i>  <span>ä¹¦å•</span> </a> </li>  <li> <a href="/movies" >  <i class="fa fa-film" style="left: 25px; position: absolute;"></i>  <span>ç”µå½±</span> </a> </li>  <li> <a href="/games" >  <i class="fa fa-gamepad" style="left: 25px; position: absolute;"></i>  <span>æ¸¸æˆ</span> </a> </li>  </ul>  </li>  <li class="m-nav-item">  <a href="javascript:;">  <i class="fa fa-fw fa-leaf"></i>  å…³äº <span class="m-icon"><i class="fa fa-chevron-right"></i></span> </a> <ul>  <li> <a href="/about" >  <i class="fa fa-user" style="left: 25px; position: absolute;"></i>  <span>ç®€ä»‹</span> </a> </li>  <li> <a href="/galleries" >  <i class="fa fa-camera" style="left: 25px; position: absolute;"></i>  <span>ç›¸å†Œ</span> </a> </li>  <li> <a href="/friends" >  <i class="fa fa-handshake-o" style="left: 25px; position: absolute;"></i>  <span>å‹é“¾</span> </a> </li>  <li> <a href="/log" >  <i class="fa fa-pencil-square-o" style="left: 25px; position: absolute;"></i>  <span>æ—¥å¿—</span> </a> </li>  <li> <a href="/tags" >  <i class="fa fa-tags" style="left: 25px; position: absolute;"></i>  <span>æ ‡ç­¾</span> </a> </li>  <li> <a href="/archives" >  <i class="fa fa-archive" style="left: 25px; position: absolute;"></i>  <span>å½’æ¡£</span> </a> </li>  </ul>  </li>  <li class="m-nav-item">  <a href="/contact" class="waves-effect waves-light">  <i class="fa fa-fw fa-commenting"></i>  ç•™è¨€ </a>  </li>   <li><div class="divider"></div></li> <li> <a href="https://github.com/CdqPT" class="waves-effect waves-light" target="_blank"> <i class="fa fa-github-square fa-fw"></i>Fork Me </a> </li>  </ul>








</div>



        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #000;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/CdqPT" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>
</header>


    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('è¯·è¾“å…¥è®¿é—®æœ¬æ–‡ç« çš„å¯†ç ')).toString(CryptoJS.enc.Hex)) {
                alert('å¯†ç é”™è¯¯ï¼Œå°†è¿”å›ä¸»é¡µï¼');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://blogcdq.oss-cn-beijing.aliyuncs.com/image/other/star.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        C++å¤šçº¿ç¨‹
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before  /*,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before */{
        display: block;
        content: "ğŸ”–";
        position: absolute;
        left: 50px;
        /*color: #EE7942;*/
        /*color: red;*/
    }
        @media only screen and (max-width: 992px) {
    #articleContent h1::before{
        display: block;
        content: " ";
    }
}

    /*ä¿®æ”¹æ»šåŠ¨æ¡æ ·å¼ä¸ºéšè—*/
    #toc-content {
        height: calc(105vh - 250px);
        overflow-x: hidden;
        overflow-y: scroll;
        width: 320px;
        height: 600px;
    }
    #hidden{
        overflow: hidden;
        width: 300px;    
    }  

    #articleContent :focus {
        outline: none;
    }
    .toc-fixed {
        position: fixed;
        top: 64px;
    }
    .toc-widget {
        padding-left: 20px;
    }
    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 40px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }
    .toc-widget ol {
        padding: 0;
        list-style: none;
    }
    #toc-content ol {
        padding-left: 10px;
    }
    #toc-content ol li {
        padding-left: 30px;
    }
    #toc-content .toc-link:hover {
        color: black;
        font-weight: 700;
        text-decoration: underline;
    }
    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }
    #toc-content .is-active-link {
        color: red;
    }
    #toc-content .is-active-link::before {
        background-color: red;
    }
    #floating-toc-btn {
        position: fixed;
        right: 0.6rem;
        bottom: 6rem;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
        opacity: 0.5;
    }
    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }
    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/CPlus/" target="_blank">
                                <span class="chip bg-color">CPlus</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/ç¬”è®°/" class="post-category" target="_blank">
                                ç¬”è®°
                            </a>
                        
                    </div>
                    
                </div>
            </div>




               <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="fa fa-pencil fa-fw"></i>å‘å¸ƒæ—¥æœŸ:&nbsp;&nbsp;
                    2019-10-05
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="fa fa-refresh fa-fw"></i>æ›´æ–°æ—¥æœŸ:&nbsp;&nbsp;
                    2020-02-13
                </div>
                

                

                
                
                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>é˜…è¯»æ¬¡æ•°:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
                
            </div>
            
        </div>

        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>C++11 æ–°æ ‡å‡†ä¸­å¼•å…¥äº†å››ä¸ªå¤´æ–‡ä»¶æ¥æ”¯æŒå¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œä»–ä»¬åˆ†åˆ«æ˜¯<code>&lt;atomic&gt; ,&lt;thread&gt;,&lt;mutex&gt;,&lt;condition_variable&gt;å’Œ&lt;future&gt;</code>ã€‚</p>
<p><code>&lt;atomic&gt;</code>ï¼šè¯¥å¤´æ–‡ä¸»è¦å£°æ˜äº†ä¸¤ä¸ªç±», std::atomic å’Œ std::atomic_flagï¼Œå¦å¤–è¿˜å£°æ˜äº†ä¸€å¥— C é£æ ¼çš„åŸå­ç±»å‹å’Œä¸ C å…¼å®¹çš„åŸå­æ“ä½œçš„å‡½æ•°ã€‚<br><code>&lt;thread&gt;</code>ï¼šè¯¥å¤´æ–‡ä»¶ä¸»è¦å£°æ˜äº† std::thread ç±»ï¼Œå¦å¤– std::this_thread å‘½åç©ºé—´ä¹Ÿåœ¨è¯¥å¤´æ–‡ä»¶ä¸­ã€‚<br><code>&lt;mutex&gt;</code>ï¼šè¯¥å¤´æ–‡ä»¶ä¸»è¦å£°æ˜äº†ä¸äº’æ–¥é‡(mutex)ç›¸å…³çš„ç±»ï¼ŒåŒ…æ‹¬ std::mutex ç³»åˆ—ç±»ï¼Œstd::lock_guard, std::unique_lock, ä»¥åŠå…¶ä»–çš„ç±»å‹å’Œå‡½æ•°ã€‚<br><code>&lt;condition_variable&gt;</code>ï¼šè¯¥å¤´æ–‡ä»¶ä¸»è¦å£°æ˜äº†ä¸æ¡ä»¶å˜é‡ç›¸å…³çš„ç±»ï¼ŒåŒ…æ‹¬ std::condition_variable å’Œ std::condition_variable_anyã€‚<br><code>&lt;future&gt;</code>ï¼šè¯¥å¤´æ–‡ä»¶ä¸»è¦å£°æ˜äº† std::promise, std::package_task ä¸¤ä¸ª Provider ç±»ï¼Œä»¥åŠ std::future å’Œ std::shared_future ä¸¤ä¸ª Future ç±»ï¼Œå¦å¤–è¿˜æœ‰ä¸€äº›ä¸ä¹‹ç›¸å…³çš„ç±»å‹å’Œå‡½æ•°ï¼Œstd::async() å‡½æ•°å°±å£°æ˜åœ¨æ­¤å¤´æ–‡ä»¶ä¸­ã€‚</p>
<h1 id="ä¸€ã€åº“"><a href="#ä¸€ã€åº“" class="headerlink" title="ä¸€ã€åº“"></a>ä¸€ã€<thread>åº“</thread></h1><table>
<thead>
<tr>
<th align="center">å‡½æ•°</th>
<th align="center">ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">std::thread::thread(Function&amp;&amp; f, Args&amp;&amp;â€¦ args);</td>
<td align="center">åˆ›å»ºçº¿ç¨‹</td>
</tr>
<tr>
<td align="center">std::thread::join();</td>
<td align="center">ç­‰å¾…çº¿ç¨‹ç»“æŸ</td>
</tr>
<tr>
<td align="center">std::thread::detach();</td>
<td align="center">è„±ç¦»çº¿ç¨‹æ§åˆ¶</td>
</tr>
<tr>
<td align="center">std::thread::swap(thread&amp; other);</td>
<td align="center">äº¤æ¢çº¿ç¨‹</td>
</tr>
</tbody></table>
<h2 id="1-1-åŸºæœ¬ç”¨æ³•"><a href="#1-1-åŸºæœ¬ç”¨æ³•" class="headerlink" title="1.1 åŸºæœ¬ç”¨æ³•"></a>1.1 åŸºæœ¬ç”¨æ³•</h2><pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread></span>  </span>

using namespace std<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">th_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"hello thread."</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread <span class="token function">t</span><span class="token punctuation">(</span>th_function<span class="token punctuation">)</span><span class="token punctuation">;</span>
   t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>hello thread.</code></pre><h2 id="1-2-çº¿ç¨‹å‚æ•°"><a href="#1-2-çº¿ç¨‹å‚æ•°" class="headerlink" title="1.2 çº¿ç¨‹å‚æ•°"></a>1.2 çº¿ç¨‹å‚æ•°</h2><pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>

<span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Hello "</span> <span class="token operator">&lt;&lt;</span> name <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread <span class="token function">thread</span><span class="token punctuation">(</span>hello<span class="token punctuation">,</span> <span class="token string">"C++11"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>Hello C++11</code></pre><h2 id="1-3-ç±»æˆå‘˜å‡½æ•°åšä¸ºçº¿ç¨‹å…¥å£"><a href="#1-3-ç±»æˆå‘˜å‡½æ•°åšä¸ºçº¿ç¨‹å…¥å£" class="headerlink" title="1.3 ç±»æˆå‘˜å‡½æ•°åšä¸ºçº¿ç¨‹å…¥å£"></a>1.3 ç±»æˆå‘˜å‡½æ•°åšä¸ºçº¿ç¨‹å…¥å£</h2><p>ç±»æˆå‘˜å‡½æ•°åšä¸ºçº¿ç¨‹å…¥å£æ—¶ï¼Œä»ç„¶ååˆ†ç®€å•: æŠŠthisåšä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’è¿›å»å³å¯ã€‚</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>

class Greet
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>owner <span class="token operator">=</span> <span class="token string">"Greet"</span><span class="token punctuation">;</span>
public<span class="token punctuation">:</span>
    <span class="token keyword">void</span> <span class="token function">SayHello</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Hello "</span> <span class="token operator">&lt;&lt;</span> name <span class="token operator">&lt;&lt;</span> <span class="token string">" from "</span> <span class="token operator">&lt;&lt;</span> this<span class="token operator">-></span>owner <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Greet greet<span class="token punctuation">;</span>

    std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread <span class="token function">thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Greet<span class="token punctuation">:</span><span class="token punctuation">:</span>SayHello<span class="token punctuation">,</span> <span class="token operator">&amp;</span>greet<span class="token punctuation">,</span> <span class="token string">"C++11"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>Hello C++11 from Greet</code></pre><h2 id="1-4-çº¿ç¨‹æš‚åœ"><a href="#1-4-çº¿ç¨‹æš‚åœ" class="headerlink" title="1.4 çº¿ç¨‹æš‚åœ"></a>1.4 çº¿ç¨‹æš‚åœ</h2><p>ä»å¤–éƒ¨è®©çº¿ç¨‹æš‚åœï¼Œä¼šå¼•å‘å¾ˆå¤šå¹¶å‘é—®é¢˜ã€‚å¤§å®¶å¯ä»¥ç™¾åº¦ä¸€ä¸‹ï¼Œæ­¤å¤„ä¸åšå¼•ç”³ã€‚è¿™å¤§æ¦‚ä¹Ÿæ˜¯std::threadå¹¶æ²¡æœ‰ç›´æ¥æä¾›pauseå‡½æ•°çš„åŸå› ã€‚ä½†æœ‰æ—¶çº¿ç¨‹åœ¨è¿è¡Œæ—¶ï¼Œç¡®å®éœ€è¦â€œåœé¡¿â€ä¸€æ®µæ—¶é—´æ€ä¹ˆåŠå‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨std::this_thread::sleep_foræˆ–std::this_thread::sleep_until</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;chrono></span></span>

using namespace std<span class="token punctuation">:</span><span class="token punctuation">:</span>chrono<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">pausable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// sleep 500æ¯«ç§’</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>this_thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sleep_for</span><span class="token punctuation">(</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// sleep åˆ°æŒ‡å®šæ—¶é—´ç‚¹</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>this_thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sleep_until</span><span class="token punctuation">(</span>system_clock<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread <span class="token function">thread</span><span class="token punctuation">(</span>pausable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="1-5-çº¿ç¨‹åœæ­¢"><a href="#1-5-çº¿ç¨‹åœæ­¢" class="headerlink" title="1.5 çº¿ç¨‹åœæ­¢"></a>1.5 çº¿ç¨‹åœæ­¢</h2><p>ä¸€èˆ¬æƒ…å†µä¸‹å½“çº¿ç¨‹å‡½æ•°æ‰§è¡Œå®Œæˆåï¼Œçº¿ç¨‹â€œè‡ªç„¶â€åœæ­¢ã€‚ä½†åœ¨std::threadä¸­æœ‰ä¸€ç§æƒ…å†µä¼šé€ æˆçº¿ç¨‹å¼‚å¸¸ç»ˆæ­¢ï¼Œé‚£å°±æ˜¯ï¼šææ„ã€‚å½“std::threadå®ä¾‹ææ„æ—¶ï¼Œå¦‚æœçº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œåˆ™çº¿ç¨‹ä¼šè¢«å¼ºè¡Œç»ˆæ­¢æ‰ï¼Œè¿™å¯èƒ½ä¼šé€ æˆèµ„æºçš„æ³„æ¼ï¼Œå› æ­¤å°½é‡åœ¨ææ„å‰joinä¸€ä¸‹ï¼Œä»¥ç¡®ä¿çº¿ç¨‹æˆåŠŸç»“æŸã€‚<br>å¦‚æœç¡®å®æƒ³æå‰è®©çº¿ç¨‹ç»“æŸæ€ä¹ˆåŠå‘¢ï¼Ÿä¸€ä¸ªç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨â€œå…±äº«å˜é‡â€ï¼Œçº¿ç¨‹å®šæœŸåœ°å»æ£€æµ‹è¯¥é‡ï¼Œå¦‚æœéœ€è¦é€€å‡ºï¼Œåˆ™åœæ­¢æ‰§è¡Œï¼Œé€€å‡ºçº¿ç¨‹å‡½æ•°ã€‚ä½¿ç”¨â€œå…±äº«å˜é‡â€éœ€è¦æ³¨æ„ï¼Œåœ¨å¤šæ ¸ã€å¤šCPUçš„æƒ…å†µä¸‹éœ€è¦ä½¿ç”¨â€œåŸå­â€æ“ä½œï¼Œå…³äºåŸå­æ“ä½œåé¢ä¼šæœ‰ä¸“é¢˜è®²è¿°ã€‚</p>
<h2 id="1-6-æ‹·è´"><a href="#1-6-æ‹·è´" class="headerlink" title="1.6 æ‹·è´"></a>1.6 æ‹·è´</h2><pre class="line-numbers language-c"><code class="language-c">std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread <span class="token function">a</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread b<span class="token punctuation">;</span>
b <span class="token operator">=</span> a<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>å½“æ‰§è¡Œä»¥ä¸Šä»£ç æ—¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿæœ€ç»ˆfooçº¿ç¨‹æ˜¯ç”±aç®¡ç†ï¼Œè¿˜æ˜¯bæ¥ç®¡ç†ï¼Ÿç­”æ¡ˆæ˜¯ç”±bæ¥ç®¡ç†ã€‚std::threadè¢«è®¾è®¡ä¸ºåªèƒ½ç”±ä¸€ä¸ªå®ä¾‹æ¥ç»´æŠ¤çº¿ç¨‹çŠ¶æ€ï¼Œä»¥åŠå¯¹çº¿ç¨‹è¿›è¡Œæ“ä½œã€‚å› æ­¤å½“å‘ç”Ÿèµ‹å€¼æ“ä½œæ—¶ï¼Œä¼šå‘ç”Ÿçº¿ç¨‹æ‰€æœ‰æƒè½¬ç§»ã€‚åœ¨macosä¸‹std::threadçš„èµ‹å€¼å‡½æ•°åŸå‹ä¸º:</p>
<pre class="line-numbers language-c"><code class="language-c">thread<span class="token operator">&amp;</span> operator<span class="token operator">=</span><span class="token punctuation">(</span>thread<span class="token operator">&amp;&amp;</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>èµ‹å®Œå€¼åï¼ŒåŸæ¥ç”±aç®¡ç†çš„çº¿ç¨‹æ”¹ä¸ºç”±bç®¡ç†ï¼Œbä¸å†æŒ‡å‘ä»»ä½•çº¿ç¨‹(ç›¸å½“äºæ‰§è¡Œäº†detachæ“ä½œ)ã€‚å¦‚æœbåŸæœ¬æŒ‡å‘äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹ä¼šè¢«ç»ˆæ­¢æ‰ã€‚</p>
<h2 id="detach-joinable"><a href="#detach-joinable" class="headerlink" title="detach/joinable"></a>detach/joinable</h2><p>detachæ˜¯std::threadçš„æˆå‘˜å‡½æ•°ï¼Œå‡½æ•°åŸå‹ä¸ºï¼š</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bool <span class="token function">joinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>detachä»¥åå°±å¤±å»äº†å¯¹çº¿ç¨‹çš„æ‰€æœ‰æƒï¼Œä¸èƒ½å†è°ƒç”¨joinäº†ï¼Œå› ä¸ºçº¿ç¨‹å·²ç»åˆ†ç¦»å‡ºå»äº†ï¼Œä¸å†å½’è¯¥å®ä¾‹ç®¡äº†ã€‚åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¿˜æœ‰å¯¹çº¿ç¨‹çš„æ‰€æœ‰æƒçš„ä¸€ä¸ªç®€å•æ–¹å¼æ˜¯è°ƒç”¨joinableå‡½æ•°ï¼Œè¿”å›trueåˆ™æœ‰ï¼Œå¦åˆ™ä¸ºæ— ã€‚</p>
<h2 id="1-7-çº¿ç¨‹å†…éƒ¨è°ƒç”¨è‡ªèº«çš„join"><a href="#1-7-çº¿ç¨‹å†…éƒ¨è°ƒç”¨è‡ªèº«çš„join" class="headerlink" title="1.7 çº¿ç¨‹å†…éƒ¨è°ƒç”¨è‡ªèº«çš„join"></a>1.7 çº¿ç¨‹å†…éƒ¨è°ƒç”¨è‡ªèº«çš„join</h2><p>è‡ªå·±ç­‰å¾…è‡ªå·±æ‰§è¡Œç»“æŸï¼Ÿå¦‚æœç¨‹åºå‘˜çœŸè¿™ä¹ˆå¹²ï¼Œé‚£è¿™ä¸ªç¨‹åºå‘˜ä¸€å®šæ˜¯è„‘å­çŸ­è·¯äº†ã€‚å¯¹äºè¿™ç§è¡Œä¸ºC++11åªèƒ½æŠ›å¼‚å¸¸äº†ã€‚</p>
<h2 id="1-8-get-id"><a href="#1-8-get-id" class="headerlink" title="1.8 get_id"></a>1.8 get_id</h2><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªidï¼Œä½†æ­¤å¤„çš„get_idä¸ç³»ç»Ÿåˆ†é…ç»™çº¿ç¨‹çš„IDå¹¶ä¸ä¸€æ˜¯åŒä¸€ä¸ªä¸œä¸œã€‚å¦‚æœæƒ³å–å¾—ç³»ç»Ÿåˆ†é…çš„çº¿ç¨‹IDï¼Œå¯ä»¥è°ƒç”¨native_handleå‡½æ•°ã€‚</p>
<h2 id="1-9-é€»è¾‘è¿ç®—"><a href="#1-9-é€»è¾‘è¿ç®—" class="headerlink" title="1.9 é€»è¾‘è¿ç®—"></a>1.9 é€»è¾‘è¿ç®—</h2><p>æœ‰äº›å¹³å°ä¸‹std::threadè¿˜æ”¯æŒè‹¥å¹²é€»è¾‘è¿ç®—ï¼Œæ¯”å¦‚Visual C++, ä½†è¿™å¹¶ä¸æ˜¯æ ‡å‡†åº“çš„è¡Œä¸ºï¼Œä¸è¦åœ¨è·¨å¹³å°çš„åœºæ™¯ä¸­ä½¿ç”¨ã€‚</p>
<h1 id="äºŒã€åº“"><a href="#äºŒã€åº“" class="headerlink" title="äºŒã€åº“"></a>äºŒã€<mutex>åº“</mutex></h1><p>mutexåˆç§°äº’æ–¥é‡ï¼Œç”¨äºæä¾›å¯¹å…±äº«å˜é‡çš„äº’æ–¥è®¿é—®ã€‚C++11ä¸­mutexç›¸å…³çš„ç±»éƒ½åœ¨<mutex>å¤´æ–‡ä»¶ä¸­ã€‚å…±å››ç§äº’æ–¥ç±»:</mutex></p>
<table>
<thead>
<tr>
<th align="center">åºå·</th>
<th align="center">åç§°</th>
<th align="center">ç”¨é€”</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">std::mutex</td>
<td align="center">æœ€åŸºæœ¬ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„äº’æ–¥ç±»</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">std::recursive_mutex</td>
<td align="center">åŒä¸€çº¿ç¨‹å†…å¯é€’å½’(é‡å…¥)çš„äº’æ–¥ç±»</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">std::timed_mutex</td>
<td align="center">é™¤å…·å¤‡mutexåŠŸèƒ½å¤–ï¼Œè¿˜æä¾›äº†å¸¦æ—¶é™è¯·æ±‚é”å®šçš„èƒ½åŠ›</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">std::recursive_timed_mutex</td>
<td align="center">åŒä¸€çº¿ç¨‹å†…å¯é€’å½’(é‡å…¥)çš„timed_mutex</td>
</tr>
</tbody></table>
<p>ä¸std::threadä¸€æ ·ï¼Œmutexç›¸å…³ç±»ä¸æ”¯æŒæ‹·è´æ„é€ ã€ä¸æ”¯æŒèµ‹å€¼ã€‚åŒæ—¶mutexç±»ä¹Ÿä¸æ”¯æŒmoveè¯­ä¹‰(moveæ„é€ ã€moveèµ‹å€¼)ã€‚ä¸ç”¨æ‹…å¿ƒä¼šè¯¯ç”¨è¿™äº›æ“ä½œï¼ŒçœŸè¦è¿™ä¹ˆåšäº†çš„è¯ï¼Œç¼–è¯‘å™¨ä¼šé˜»æ­¢ä½ çš„ã€‚</p>
<h2 id="2-1-lock"><a href="#2-1-lock" class="headerlink" title="2.1  lock"></a>2.1  lock</h2><p>é”ä½äº’æ–¥é‡ã€‚è°ƒç”¨lockæ—¶æœ‰ä¸‰ç§æƒ…å†µ:</p>
<ol>
<li>å¦‚æœäº’æ–¥é‡æ²¡æœ‰è¢«é”ä½ï¼Œåˆ™è°ƒç”¨çº¿ç¨‹å°†è¯¥mutexé”ä½ï¼Œç›´åˆ°è°ƒç”¨çº¿ç¨‹è°ƒç”¨unlocké‡Šæ”¾ã€‚</li>
<li>å¦‚æœmutexå·²è¢«å…¶å®ƒçº¿ç¨‹lockï¼Œåˆ™è°ƒç”¨çº¿ç¨‹å°†è¢«é˜»å¡ï¼Œç›´åˆ°å…¶å®ƒçº¿ç¨‹unlockè¯¥mutexã€‚</li>
<li>å¦‚æœå½“å‰mutexå·²ç»è¢«è°ƒç”¨è€…çº¿ç¨‹é”ä½ï¼Œåˆ™std::mutexæ­»é”ï¼Œè€Œrecursiveç³»åˆ—åˆ™æˆåŠŸè¿”å›ã€‚</li>
</ol>
<h2 id="2-2-try-lock"><a href="#2-2-try-lock" class="headerlink" title="2.2 try_lock"></a>2.2 try_lock</h2><p>å°è¯•é”ä½mutexï¼Œè°ƒç”¨è¯¥å‡½æ•°åŒæ ·ä¹Ÿæœ‰ä¸‰ç§æƒ…å†µï¼š</p>
<ol>
<li>å¦‚æœäº’æ–¥é‡æ²¡æœ‰è¢«é”ä½ï¼Œåˆ™è°ƒç”¨çº¿ç¨‹å°†è¯¥mutexé”ä½(è¿”å›true)ï¼Œç›´åˆ°è°ƒç”¨çº¿ç¨‹è°ƒç”¨unlocké‡Šæ”¾ã€‚</li>
<li>å¦‚æœmutexå·²è¢«å…¶å®ƒçº¿ç¨‹lockï¼Œåˆ™è°ƒç”¨çº¿ç¨‹å°†å¤±è´¥ï¼Œå¹¶è¿”å›falseã€‚</li>
<li>å¦‚æœå½“å‰mutexå·²ç»è¢«è°ƒç”¨è€…çº¿ç¨‹é”ä½ï¼Œåˆ™std::mutexæ­»é”ï¼Œè€Œrecursiveç³»åˆ—åˆ™æˆåŠŸè¿”å›trueã€‚</li>
</ol>
<h2 id="2-3-unlock"><a href="#2-3-unlock" class="headerlink" title="2.3 unlock"></a>2.3 unlock</h2><p>è§£é”mutexï¼Œé‡Šæ”¾å¯¹mutexçš„æ‰€æœ‰æƒã€‚å€¼å¾—ä¸€æçš„æ—¶ï¼Œå¯¹äºrecursiveç³»åˆ—mutexï¼Œunlockæ¬¡æ•°éœ€è¦ä¸lockæ¬¡æ•°ç›¸åŒæ‰å¯ä»¥å®Œå…¨è§£é”ã€‚<br>ä¸‹é¢ç»™å‡ºä¸€ä¸ªmutexå°ä¾‹å­</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mutex></span></span>

<span class="token keyword">void</span> <span class="token function">inc</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>mutex <span class="token operator">&amp;</span>mutex<span class="token punctuation">,</span> <span class="token keyword">int</span> loop<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>counter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> loop<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>counter<span class="token punctuation">;</span>
        mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread threads<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>mutex mutex<span class="token punctuation">;</span>
    <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread <span class="token operator">&amp;</span>thr<span class="token punctuation">:</span> threads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        thr <span class="token operator">=</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">thread</span><span class="token punctuation">(</span>inc<span class="token punctuation">,</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">ref</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">ref</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread <span class="token operator">&amp;</span>thr<span class="token punctuation">:</span> threads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        thr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// è¾“å‡ºï¼š5000ï¼Œå¦‚æœincä¸­è°ƒç”¨çš„æ˜¯try_lockï¼Œåˆ™æ­¤å¤„å¯èƒ½ä¼š&lt;5000</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> counter <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-4-try-lock-for-try-lock-until"><a href="#2-4-try-lock-for-try-lock-until" class="headerlink" title="2.4 try_lock_for, try_lock_until"></a>2.4 try_lock_for, try_lock_until</h2><p>è¿™ä¸¤ä¸ªå‡½æ•°ä»…ç”¨äºtimedç³»åˆ—çš„mutex(std::timed_mutex, std::recursive_timed_mutex)ï¼Œå‡½æ•°æœ€å¤šä¼šç­‰å¾…æŒ‡å®šçš„æ—¶é—´ï¼Œå¦‚æœä»æœªè·å¾—é”ï¼Œåˆ™è¿”å›falseã€‚é™¤è¶…æ—¶è®¾å®šå¤–ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°ä¸try_lockè¡Œä¸ºä¸€è‡´ã€‚</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// ç­‰å¾…æŒ‡å®šæ—¶é•¿</span>
template <span class="token operator">&lt;</span>class Rep<span class="token punctuation">,</span> class Period<span class="token operator">></span>
    <span class="token function">try_lock_for</span><span class="token punctuation">(</span><span class="token keyword">const</span> chrono<span class="token punctuation">:</span><span class="token punctuation">:</span>duration<span class="token operator">&lt;</span>Rep<span class="token punctuation">,</span> Period<span class="token operator">></span><span class="token operator">&amp;</span> rel_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// ç­‰å¾…åˆ°æŒ‡å®šæ—¶é—´</span>
template <span class="token operator">&lt;</span>class Clock<span class="token punctuation">,</span> class Duration<span class="token operator">></span>
    <span class="token function">try_lock_until</span><span class="token punctuation">(</span><span class="token keyword">const</span> chrono<span class="token punctuation">:</span><span class="token punctuation">:</span>time_point<span class="token operator">&lt;</span>Clock<span class="token punctuation">,</span> Duration<span class="token operator">></span><span class="token operator">&amp;</span> abs_time<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>try_lock_forç›¸å…³ä»£ç </p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mutex></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;chrono></span></span>

<span class="token keyword">void</span> <span class="token function">run500ms</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>timed_mutex <span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> _500ms <span class="token operator">=</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>chrono<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">.</span><span class="token function">try_lock_for</span><span class="token punctuation">(</span>_500ms<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"è·å¾—äº†é”"</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"æœªè·å¾—é”"</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>timed_mutex mutex<span class="token punctuation">;</span>

    mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread <span class="token function">thread</span><span class="token punctuation">(</span>run500ms<span class="token punctuation">,</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">ref</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//è¾“å‡ºï¼šæœªè·å¾—é”</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-5-lock-guard"><a href="#2-5-lock-guard" class="headerlink" title="2.5 lock_guard"></a>2.5 lock_guard</h2><p>lock_guardåˆ©ç”¨äº†C++ RAIIçš„ç‰¹æ€§ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­ä¸Šé”ï¼Œææ„å‡½æ•°ä¸­è§£é”ã€‚lock_guardæ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œå…¶åŸå‹ä¸º</p>
<pre><code>template &lt;class Mutex&gt; class lock_guard</code></pre><p>æ¨¡æ¿å‚æ•°Mutexä»£è¡¨äº’æ–¥é‡ï¼Œå¯ä»¥æ˜¯ä¸Šä¸€ç¯‡ä»‹ç»çš„std::mutex, std::timed_mutex, std::recursive_mutex, std::recursive_timed_mutexä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥æ˜¯std::unique_lock(ä¸‹é¢å³å°†ä»‹ç»)ï¼Œè¿™äº›éƒ½æä¾›äº†lockå’Œunlockçš„èƒ½åŠ›ã€‚<br>lock_guardä»…ç”¨äºä¸Šé”ã€è§£é”ï¼Œä¸å¯¹mutexæ‰¿æ‹…ä¾›ä»»ä½•ç”Ÿå‘¨æœŸçš„ç®¡ç†ï¼Œå› æ­¤åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œè¯·ç¡®ä¿lock_guardç®¡ç†çš„mutexä¸€ç›´æœ‰æ•ˆã€‚<br>åŒå…¶å®ƒmutexç±»ä¸€æ ·ï¼Œlocak_guardä¸å…è®¸æ‹·è´ï¼Œå³æ‹·è´æ„é€ å’Œèµ‹å€¼å‡½æ•°è¢«å£°æ˜ä¸ºdeleteã€‚</p>
<pre><code>lock_guard(lock_guard const&amp;) = delete;
lock_guard&amp; operator=(lock_guard const&amp;) = delete;</code></pre><p>lock_guardçš„è®¾è®¡ä¿è¯äº†å³ä½¿ç¨‹åºåœ¨é”å®šæœŸé—´å‘ç”Ÿäº†å¼‚å¸¸ï¼Œä¹Ÿä¼šå®‰å…¨çš„é‡Šæ”¾é”ï¼Œä¸ä¼šå‘ç”Ÿæ­»é”ã€‚</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mutex></span></span>

std<span class="token punctuation">:</span><span class="token punctuation">:</span>mutex mutex<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">safe_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    try <span class="token punctuation">{</span>
        std<span class="token punctuation">:</span><span class="token punctuation">:</span>lock_guard<span class="token operator">&lt;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>mutex<span class="token operator">></span> <span class="token function">_guard</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        throw std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">logic_error</span><span class="token punctuation">(</span><span class="token string">"logic error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>exception <span class="token operator">&amp;</span>ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token punctuation">:</span><span class="token punctuation">:</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"[caught] "</span> <span class="token operator">&lt;&lt;</span> ex<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">safe_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// æ­¤å¤„ä»èƒ½ä¸Šé”</span>
    mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"OK, still locked"</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
    mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>[caught] logic error
OK, still locked </code></pre><h2 id="2-6-unique-lock"><a href="#2-6-unique-lock" class="headerlink" title="2.6  unique_lock"></a>2.6  unique_lock</h2><p>lock_guardæä¾›äº†ç®€å•ä¸Šé”ã€è§£é”æ“ä½œï¼Œä½†å½“æˆ‘ä»¬éœ€è¦æ›´çµæ´»çš„æ“ä½œæ—¶ä¾¿æ— èƒ½ä¸ºåŠ›äº†ã€‚è¿™äº›å°±éœ€è¦unique_lockä¸Šåœºäº†ã€‚unique_lockæ‹¥æœ‰å¯¹Mutexçš„æ‰€æœ‰æƒï¼Œä¸€ä½†åˆå§‹åŒ–äº†unique_lockï¼Œå…¶å°±æ¥ç®¡äº†è¯¥mutex, åœ¨unique_lockç»“æŸç”Ÿå‘½å‘¨æœŸå‰(ææ„å‰)ï¼Œå…¶å®ƒåœ°æ–¹å°±ä¸è¦å†ç›´æ¥ä½¿ç”¨è¯¥mutexäº†ã€‚unique_lockæä¾›çš„åŠŸèƒ½è¾ƒå¤šï¼Œæ­¤å¤„ä¸ä¸€ä¸€åˆ—ä¸¾ï¼Œä¸‹é¢åˆ—å‡ºunique_lockçš„ç±»å£°æ˜ï¼ŒåŠéƒ¨åˆ†æ³¨é‡Šï¼Œä¾›å¤§å®¶å‚è€ƒ</p>
<pre class="line-numbers language-c"><code class="language-c">template <span class="token operator">&lt;</span>class Mutex<span class="token operator">></span>
class unique_lock
<span class="token punctuation">{</span>
public<span class="token punctuation">:</span>
    <span class="token keyword">typedef</span> Mutex mutex_type<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ç©ºunique_lockå¯¹è±¡</span>
    <span class="token function">unique_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ç®¡ç†m, å¹¶è°ƒç”¨m.lockè¿›è¡Œä¸Šé”ï¼Œå¦‚æœmå·²è¢«å…¶å®ƒçº¿ç¨‹é”å®šï¼Œç”±è¯¥æ„é€ äº†å‡½æ•°ä¼šé˜»å¡ã€‚</span>
    explicit <span class="token function">unique_lock</span><span class="token punctuation">(</span>mutex_type<span class="token operator">&amp;</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ä»…ç®¡ç†mï¼Œæ„é€ å‡½æ•°ä¸­ä¸å¯¹mä¸Šé”ã€‚å¯ä»¥åœ¨åˆå§‹åŒ–åè°ƒç”¨lock, try_lock, try_lock_xxxç³»åˆ—è¿›è¡Œä¸Šé”ã€‚</span>
    <span class="token function">unique_lock</span><span class="token punctuation">(</span>mutex_type<span class="token operator">&amp;</span> m<span class="token punctuation">,</span> defer_lock_t<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ç®¡ç†m, å¹¶è°ƒç”¨m.try_lockï¼Œä¸Šé”ä¸æˆåŠŸä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹</span>
    <span class="token function">unique_lock</span><span class="token punctuation">(</span>mutex_type<span class="token operator">&amp;</span> m<span class="token punctuation">,</span> try_to_lock_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ç®¡ç†m, è¯¥å‡½æ•°å‡è®¾må·²ç»è¢«å½“å‰çº¿ç¨‹é”å®šï¼Œä¸å†å°è¯•ä¸Šé”ã€‚</span>
    <span class="token function">unique_lock</span><span class="token punctuation">(</span>mutex_type<span class="token operator">&amp;</span> m<span class="token punctuation">,</span> adopt_lock_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ç®¡ç†m, å¹¶è°ƒç”¨m.try_lock_unitilå‡½æ•°è¿›è¡ŒåŠ é”</span>
    template <span class="token operator">&lt;</span>class Clock<span class="token punctuation">,</span> class Duration<span class="token operator">></span>
        <span class="token function">unique_lock</span><span class="token punctuation">(</span>mutex_type<span class="token operator">&amp;</span> m<span class="token punctuation">,</span> <span class="token keyword">const</span> chrono<span class="token punctuation">:</span><span class="token punctuation">:</span>time_point<span class="token operator">&lt;</span>Clock<span class="token punctuation">,</span> Duration<span class="token operator">></span><span class="token operator">&amp;</span> abs_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ç®¡ç†mï¼Œå¹¶è°ƒç”¨m.try_lock_forå‡½æ•°è¿›è¡ŒåŠ é”</span>
    template <span class="token operator">&lt;</span>class Rep<span class="token punctuation">,</span> class Period<span class="token operator">></span>
        <span class="token function">unique_lock</span><span class="token punctuation">(</span>mutex_type<span class="token operator">&amp;</span> m<span class="token punctuation">,</span> <span class="token keyword">const</span> chrono<span class="token punctuation">:</span><span class="token punctuation">:</span>duration<span class="token operator">&lt;</span>Rep<span class="token punctuation">,</span> Period<span class="token operator">></span><span class="token operator">&amp;</span> rel_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ææ„ï¼Œå¦‚æœæ­¤å‰æˆåŠŸåŠ é”(æˆ–é€šè¿‡adopt_lock_tè¿›è¡Œæ„é€ )ï¼Œå¹¶ä¸”å¯¹mutexæ‹¥æœ‰æ‰€æœ‰æƒï¼Œåˆ™è§£é”mutex</span>
    <span class="token operator">~</span><span class="token function">unique_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ç¦æ­¢æ‹·è´æ“ä½œ</span>
    <span class="token function">unique_lock</span><span class="token punctuation">(</span>unique_lock <span class="token keyword">const</span><span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> delete<span class="token punctuation">;</span>
    unique_lock<span class="token operator">&amp;</span> operator<span class="token operator">=</span><span class="token punctuation">(</span>unique_lock <span class="token keyword">const</span><span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> delete<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// æ”¯æŒmoveè¯­ä¹‰</span>
    <span class="token function">unique_lock</span><span class="token punctuation">(</span>unique_lock<span class="token operator">&amp;&amp;</span> u<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>
    unique_lock<span class="token operator">&amp;</span> operator<span class="token operator">=</span><span class="token punctuation">(</span>unique_lock<span class="token operator">&amp;&amp;</span> u<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bool <span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    template <span class="token operator">&lt;</span>class Rep<span class="token punctuation">,</span> class Period<span class="token operator">></span>
        bool <span class="token function">try_lock_for</span><span class="token punctuation">(</span><span class="token keyword">const</span> chrono<span class="token punctuation">:</span><span class="token punctuation">:</span>duration<span class="token operator">&lt;</span>Rep<span class="token punctuation">,</span> Period<span class="token operator">></span><span class="token operator">&amp;</span> rel_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    template <span class="token operator">&lt;</span>class Clock<span class="token punctuation">,</span> class Duration<span class="token operator">></span>
        bool <span class="token function">try_lock_until</span><span class="token punctuation">(</span><span class="token keyword">const</span> chrono<span class="token punctuation">:</span><span class="token punctuation">:</span>time_point<span class="token operator">&lt;</span>Clock<span class="token punctuation">,</span> Duration<span class="token operator">></span><span class="token operator">&amp;</span> abs_time<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// æ˜¾ç¤ºå¼è§£é”ï¼Œè¯¥å‡½æ•°è°ƒç”¨åï¼Œé™¤éå†æ¬¡è°ƒç”¨lockç³»åˆ—å‡½æ•°è¿›è¡Œä¸Šé”ï¼Œå¦åˆ™ææ„ä¸­ä¸å†è¿›è¡Œè§£é”</span>
    <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ä¸å¦ä¸€ä¸ªunique_lockäº¤æ¢æ‰€æœ‰æƒ</span>
    <span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>unique_lock<span class="token operator">&amp;</span> u<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// è¿”å›å½“å‰ç®¡ç†çš„mutexå¯¹è±¡çš„æŒ‡é’ˆï¼Œå¹¶é‡Šæ”¾æ‰€æœ‰æƒ</span>
    mutex_type<span class="token operator">*</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// å½“å‰å®ä¾‹æ˜¯å¦è·å¾—äº†é”</span>
    bool <span class="token function">owns_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> noexcept<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// åŒowns_lock</span>
    explicit operator <span class="token function">bool</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> noexcept<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// è¿”å›mutexæŒ‡é’ˆï¼Œä¾¿äºå¼€å‘äººå‘˜è¿›è¡Œæ›´çµæ´»çš„æ“ä½œ</span>
    <span class="token comment" spellcheck="true">// æ³¨æ„ï¼šæ­¤æ—¶mutexçš„æ‰€æœ‰æƒä»å½’unique_lockæ‰€æœ‰ï¼Œå› æ­¤ä¸è¦å¯¹mutexè¿›è¡ŒåŠ é”ã€è§£é”æ“ä½œ</span>
    mutex_type<span class="token operator">*</span> <span class="token function">mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> noexcept<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-7-std-call-once"><a href="#2-7-std-call-once" class="headerlink" title="2.7 std::call_once"></a>2.7 std::call_once</h2><p>è¯¥å‡½æ•°çš„ä½œç”¨é¡¾åæ€ä¹‰ï¼šä¿è¯call_onceè°ƒç”¨çš„å‡½æ•°åªè¢«æ‰§è¡Œä¸€æ¬¡ã€‚è¯¥å‡½æ•°éœ€è¦ä¸std::once_flagé…åˆä½¿ç”¨ã€‚std::once_flagè¢«è®¾è®¡ä¸ºå¯¹å¤–å°é—­çš„ï¼Œå³å¤–éƒ¨æ²¡æœ‰ä»»ä½•æ¸ é“å¯ä»¥æ”¹å˜once_flagçš„å€¼ï¼Œä»…å¯ä»¥é€šè¿‡std::call_onceå‡½æ•°ä¿®æ”¹ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬åœ¨è‡ªå·±å®ç°call_onceæ•ˆæœæ—¶ï¼Œå¾€å¾€ä½¿ç”¨ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä»¥åŠåŒé‡æ£€æŸ¥é”(DCL)æ¥å®ç°ï¼Œå³ä¾¿è¿™æ ·è¯¥å®ç°ä»ç„¶ä¼šæœ‰å¾ˆå¤šå‘(å¤šæ ¸ç¯å¢ƒä¸‹)ã€‚æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥æœç´¢ä¸€ä¸‹DCLæ¥çœ‹ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚<br>C++11ä¸ºæˆ‘ä»¬æä¾›äº†ç®€ä¾¿çš„è§£å†³æ–¹æ¡ˆï¼Œæ‰€éœ€åšçš„ä»…ä»…åƒä¸‹é¢è¿™æ ·ä½¿ç”¨å³å¯ã€‚</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mutex></span></span>

<span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> __FUNCTION__ <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

std<span class="token punctuation">:</span><span class="token punctuation">:</span>once_flag of<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">my_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">call_once</span><span class="token punctuation">(</span>of<span class="token punctuation">,</span> initialize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread threads<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread <span class="token operator">&amp;</span>thr<span class="token punctuation">:</span> threads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        thr <span class="token operator">=</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">thread</span><span class="token punctuation">(</span>my_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread <span class="token operator">&amp;</span>thr<span class="token punctuation">:</span> threads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        thr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// ä»…è¾“å‡ºä¸€æ¬¡ï¼šinitialize</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-8-std-try-lock"><a href="#2-8-std-try-lock" class="headerlink" title="2.8 std::try_lock"></a>2.8 std::try_lock</h2><p>å½“æœ‰å¤šä¸ªmutexéœ€è¦æ‰§è¡Œtry_lockæ—¶ï¼Œè¯¥å‡½æ•°æä¾›äº†ç®€ä¾¿çš„æ“ä½œã€‚try_lockä¼šæŒ‰å‚æ•°ä»å·¦åˆ°å³çš„é¡ºåºï¼Œå¯¹mutexé¡ºæ¬¡æ‰§è¡Œtry_lockæ“ä½œã€‚å½“å…¶ä¸­æŸä¸ªmutex.try_lockå¤±è´¥(è¿”å›falseæˆ–æŠ›å‡ºå¼‚å¸¸)æ—¶ï¼Œå·²æˆåŠŸé”å®šçš„mutexéƒ½å°†è¢«è§£é”ã€‚<br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥å‡½æ•°æˆåŠŸæ—¶è¿”å›-1ï¼Œ å¦åˆ™è¿”å›å¤±è´¥mutexçš„ç´¢å¼•ï¼Œç´¢å¼•ä»0å¼€å§‹è®¡æ•°ã€‚</p>
<pre class="line-numbers language-c"><code class="language-c">template <span class="token operator">&lt;</span>class L1<span class="token punctuation">,</span> class L2<span class="token punctuation">,</span> class<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L3<span class="token operator">></span>
  <span class="token keyword">int</span> <span class="token function">try_lock</span><span class="token punctuation">(</span>L1<span class="token operator">&amp;</span><span class="token punctuation">,</span> L2<span class="token operator">&amp;</span><span class="token punctuation">,</span> L3<span class="token operator">&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="2-9-std-lock"><a href="#2-9-std-lock" class="headerlink" title="2.9 std::lock"></a>2.9 std::lock</h2><p>std::lockæ˜¯è¾ƒæ™ºèƒ½çš„ä¸Šæ‰¹é‡ä¸Šé”æ–¹å¼ï¼Œé‡‡ç”¨æ­»é”ç®—æ³•æ¥é”å®šç»™å®šçš„mutexåˆ—è¡¨ï¼Œé¿å…æ­»é”ã€‚è¯¥å‡½æ•°å¯¹mutexåˆ—è¡¨çš„ä¸Šé”é¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚è¯¥å‡½æ•°ä¿è¯: å¦‚æœæˆåŠŸï¼Œåˆ™æ‰€æœ‰mutexå…¨éƒ¨ä¸Šé”ï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™å…¨éƒ¨è§£é”ã€‚</p>
<pre class="line-numbers language-c"><code class="language-c">template <span class="token operator">&lt;</span>class L1<span class="token punctuation">,</span> class L2<span class="token punctuation">,</span> class<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L3<span class="token operator">></span>
  <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span>L1<span class="token operator">&amp;</span><span class="token punctuation">,</span> L2<span class="token operator">&amp;</span><span class="token punctuation">,</span> L3<span class="token operator">&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="ä¸‰ã€æ¡ä»¶å˜é‡"><a href="#ä¸‰ã€æ¡ä»¶å˜é‡" class="headerlink" title="ä¸‰ã€æ¡ä»¶å˜é‡"></a>ä¸‰ã€æ¡ä»¶å˜é‡</h1><p>å‰é¢æˆ‘ä»¬ä»‹ç»äº†çº¿ç¨‹(std::thread)å’Œäº’æ–¥é‡(std::mutex)ï¼Œäº’æ–¥é‡æ˜¯å¤šçº¿ç¨‹é—´åŒæ—¶è®¿é—®æŸä¸€å…±äº«å˜é‡æ—¶ï¼Œä¿è¯å˜é‡å¯è¢«å®‰å…¨è®¿é—®çš„æ‰‹æ®µã€‚åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œè¿˜æœ‰å¦ä¸€ç§ååˆ†å¸¸è§çš„è¡Œä¸ºï¼šçº¿ç¨‹åŒæ­¥ã€‚çº¿ç¨‹åŒæ­¥æ˜¯æŒ‡çº¿ç¨‹é—´éœ€è¦æŒ‰ç…§é¢„å®šçš„å…ˆåæ¬¡åºé¡ºåºè¿›è¡Œçš„è¡Œä¸ºã€‚C++11å¯¹è¿™ç§è¡Œä¸ºä¹Ÿæä¾›äº†æœ‰åŠ›çš„æ”¯æŒï¼Œè¿™å°±æ˜¯æ¡ä»¶å˜é‡ã€‚æ¡ä»¶å˜é‡ä½äºå¤´æ–‡ä»¶condition_variableä¸‹ã€‚æœ¬ç« æˆ‘ä»¬å°†ç®€è¦ä»‹ç»ä¸€ä¸‹è¯¥ç±»ï¼Œåœ¨æ–‡ç« çš„æœ€åæˆ‘ä»¬ä¼šç»¼åˆè¿ç”¨std::mutexå’Œstd::condition_variableï¼Œå®ç°ä¸€ä¸ªchanç±»ï¼Œè¯¥ç±»å¯åœ¨å¤šçº¿ç¨‹é—´å®‰å…¨çš„é€šä¿¡ï¼Œå…·æœ‰å¹¿æ³›çš„åº”ç”¨åœºæ™¯ã€‚</p>
<h2 id="3-1-std-condition-variable"><a href="#3-1-std-condition-variable" class="headerlink" title="3.1 std::condition_variable"></a>3.1 std::condition_variable</h2><p>æ¡ä»¶å˜é‡æä¾›äº†ä¸¤ç±»æ“ä½œï¼šwaitå’Œnotifyã€‚è¿™ä¸¤ç±»æ“ä½œæ„æˆäº†å¤šçº¿ç¨‹åŒæ­¥çš„åŸºç¡€ã€‚</p>
<h3 id="3-1-1-wait"><a href="#3-1-1-wait" class="headerlink" title="3.1.1 wait"></a>3.1.1 wait</h3><p>waitæ˜¯çº¿ç¨‹çš„ç­‰å¾…åŠ¨ä½œï¼Œç›´åˆ°å…¶å®ƒçº¿ç¨‹å°†å…¶å”¤é†’åï¼Œæ‰ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚ä¸‹é¢é€šè¿‡ä¼ªä»£ç æ¥è¯´æ˜å…¶ç”¨æ³•ï¼š</p>
<pre class="line-numbers language-c"><code class="language-c">std<span class="token punctuation">:</span><span class="token punctuation">:</span>mutex mutex<span class="token punctuation">;</span>
std<span class="token punctuation">:</span><span class="token punctuation">:</span>condition_variable cv<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// æ¡ä»¶å˜é‡ä¸ä¸´ç•ŒåŒºæœ‰å…³ï¼Œç”¨æ¥è·å–å’Œé‡Šæ”¾ä¸€ä¸ªé”ï¼Œå› æ­¤é€šå¸¸ä¼šå’Œmutexè”ç”¨ã€‚</span>
std<span class="token punctuation">:</span><span class="token punctuation">:</span>unique_lock <span class="token function">lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// æ­¤å¤„ä¼šé‡Šæ”¾lockï¼Œç„¶ååœ¨cvä¸Šç­‰å¾…ï¼Œç›´åˆ°å…¶å®ƒçº¿ç¨‹é€šè¿‡cv.notify_xxxæ¥å”¤é†’å½“å‰çº¿ç¨‹ï¼Œcvè¢«å”¤é†’åä¼šå†æ¬¡å¯¹lockè¿›è¡Œä¸Šé”ï¼Œç„¶åwaitå‡½æ•°æ‰ä¼šè¿”å›ã€‚</span>
<span class="token comment" spellcheck="true">// waitè¿”å›åå¯ä»¥å®‰å…¨çš„ä½¿ç”¨mutexä¿æŠ¤çš„ä¸´ç•ŒåŒºå†…çš„æ•°æ®ã€‚æ­¤æ—¶mutexä»ä¸ºä¸Šé”çŠ¶æ€</span>
cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯, waitæœ‰æ—¶ä¼šåœ¨æ²¡æœ‰ä»»ä½•çº¿ç¨‹è°ƒç”¨notifyçš„æƒ…å†µä¸‹è¿”å›ï¼Œè¿™ç§æƒ…å†µå°±æ˜¯æœ‰åçš„<a href="https://docs.microsoft.com/zh-cn/windows/desktop/api/synchapi/nf-synchapi-sleepconditionvariablecs" target="_blank" rel="noopener"><strong>spurious wakeup</strong></a>ã€‚å› æ­¤å½“waitè¿”å›æ—¶ï¼Œä½ éœ€è¦å†æ¬¡æ£€æŸ¥waitçš„å‰ç½®æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œå¦‚æœä¸æ»¡è¶³åˆ™éœ€è¦å†æ¬¡waitã€‚waitæä¾›äº†é‡è½½çš„ç‰ˆæœ¬ï¼Œç”¨äºæä¾›å‰ç½®æ£€æŸ¥ã€‚</p>
<pre class="line-numbers language-c"><code class="language-c">template <span class="token operator">&lt;</span>typename Predicate<span class="token operator">></span>
<span class="token keyword">void</span> <span class="token function">wait</span><span class="token punctuation">(</span>unique_lock<span class="token operator">&lt;</span>mutex<span class="token operator">></span> <span class="token operator">&amp;</span>lock<span class="token punctuation">,</span> Predicate pred<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">pred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é™¤waitå¤–, æ¡ä»¶å˜é‡è¿˜æä¾›äº†wait_forå’Œwait_untilï¼Œè¿™ä¸¤ä¸ªåç§°æ˜¯ä¸æ˜¯çœ‹ç€æœ‰ç‚¹å„¿çœ¼ç†Ÿï¼Œstd::mutexä¹Ÿæä¾›äº†_forå’Œ_untilæ“ä½œã€‚åœ¨C++11å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œéœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´çš„æ“ä½œï¼Œä¸€èˆ¬æƒ…å†µä¸‹éƒ½ä¼šæœ‰xxx_forå’Œxxx_untilç‰ˆæœ¬ã€‚å‰è€…ç”¨äºç­‰å¾…æŒ‡å®šæ—¶é•¿ï¼Œåè€…ç”¨äºç­‰å¾…åˆ°æŒ‡å®šçš„æ—¶é—´ã€‚</p>
<h3 id="3-1-2"><a href="#3-1-2" class="headerlink" title="3.1.2"></a>3.1.2</h3><p>äº†è§£äº†waitï¼Œnotifyå°±ç®€å•å¤šäº†ï¼šå”¤é†’waitåœ¨è¯¥æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹ã€‚notifyæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼šnotify_oneå’Œnotify_allã€‚</p>
<ul>
<li>notify_one å”¤é†’ç­‰å¾…çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œæ³¨æ„åªå”¤é†’ä¸€ä¸ªã€‚</li>
<li>notify_all å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ã€‚ä½¿ç”¨è¯¥å‡½æ•°æ—¶åº”é¿å…å‡ºç°<a href="https://blog.csdn.net/lyztyycode/article/details/78648798?locationNum=6&fps=1" target="_blank" rel="noopener">æƒŠç¾¤æ•ˆåº”</a>ã€‚</li>
</ul>
<p>å…¶ä½¿ç”¨æ–¹å¼è§ä¸‹ä¾‹ï¼š</p>
<pre class="line-numbers language-c"><code class="language-c">std<span class="token punctuation">:</span><span class="token punctuation">:</span>mutex mutex<span class="token punctuation">;</span>
std<span class="token punctuation">:</span><span class="token punctuation">:</span>condition_variable cv<span class="token punctuation">;</span>

std<span class="token punctuation">:</span><span class="token punctuation">:</span>unique_lock <span class="token function">lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// æ‰€æœ‰ç­‰å¾…åœ¨cvå˜é‡ä¸Šçš„çº¿ç¨‹éƒ½ä¼šè¢«å”¤é†’ã€‚ä½†ç›´åˆ°locké‡Šæ”¾äº†mutexï¼Œè¢«å”¤é†’çš„çº¿ç¨‹æ‰ä¼šä»waitè¿”å›ã€‚</span>
cv<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-2-çº¿ç¨‹é—´é€šä¿¡"><a href="#3-2-çº¿ç¨‹é—´é€šä¿¡" class="headerlink" title="3.2 çº¿ç¨‹é—´é€šä¿¡"></a>3.2 çº¿ç¨‹é—´é€šä¿¡</h2><p>æœ‰äº†ä¸Šé¢çš„åŸºç¡€æˆ‘ä»¬å°±å¯ä»¥è®¾è®¡æˆ‘ä»¬çš„çº¿ç¨‹é—´é€šè®¯å·¥å…·â€chanâ€äº†ã€‚æˆ‘ä»¬çš„è®¾è®¡ç›®æ ‡ï¼š</p>
<p>åœ¨çº¿ç¨‹é—´å®‰å…¨çš„ä¼ é€’æ•°æ®ã€‚golangç¤¾åŒºæœ‰ä¸€å¥ç»å…¸çš„è¯ï¼šä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œè¦é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ã€‚<br>æ¶ˆé™¤çº¿ç¨‹çº¿ç¨‹åŒæ­¥å¸¦æ¥çš„å¤æ‚æ€§ã€‚<br>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹chançš„å®é™…ä½¿ç”¨æ•ˆæœ, ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼ˆä¸€ä¸ªç”Ÿäº§è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ï¼‰</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"chan.h"</span>  </span><span class="token comment" spellcheck="true">// chançš„å¤´æ–‡ä»¶</span>

using namespace std<span class="token punctuation">:</span><span class="token punctuation">:</span>chrono<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// æ¶ˆè´¹æ•°æ® </span>
<span class="token keyword">void</span> <span class="token function">consume</span><span class="token punctuation">(</span>chan<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> ch<span class="token punctuation">,</span> <span class="token keyword">int</span> thread_id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> n<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>ch <span class="token operator">>></span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%d] %d\n"</span><span class="token punctuation">,</span> thread_id<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token punctuation">:</span><span class="token punctuation">:</span>this_thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sleep_for</span><span class="token punctuation">(</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    chan<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">chInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// æ¶ˆè´¹è€…</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread consumers<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        consumers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">thread</span><span class="token punctuation">(</span>consume<span class="token punctuation">,</span> chInt<span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ç”Ÿäº§æ•°æ® </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        chInt <span class="token operator">&lt;&lt;</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    chInt<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// æ•°æ®ç”Ÿäº§å®Œæ¯•</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread <span class="token operator">&amp;</span>thr<span class="token punctuation">:</span> consumers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        thr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="å››ã€å¼‚æ­¥è¿è¡Œä¹‹std-promise"><a href="#å››ã€å¼‚æ­¥è¿è¡Œä¹‹std-promise" class="headerlink" title="å››ã€å¼‚æ­¥è¿è¡Œä¹‹std::promise"></a>å››ã€å¼‚æ­¥è¿è¡Œä¹‹std::promise</h1><p>å‰é¢ä»‹ç»äº†C++11çš„std::threadã€std::mutexä»¥åŠstd::condition_variableï¼Œå¹¶å®ç°äº†ä¸€ä¸ªå¤šçº¿ç¨‹é€šä¿¡çš„chanç±»ï¼Œè™½ç„¶ç”±äºç¯‡å¹…çš„é™åˆ¶ï¼Œè¯¥å®ç°æœ‰äº›ç®€é™‹ï¼Œç”šè‡³æœ‰äº›ç¼ºé™·ï¼Œä½†å¯¹äºä¸€èˆ¬æƒ…å†µåº”è¯¥è¿˜æ˜¯å¤Ÿç”¨äº†ã€‚åœ¨C++11å¤šçº¿ç¨‹ç³»åˆ—çš„æœ€åä¼šçŒ®ä¸Šchançš„æœ€ç»ˆç‰ˆæœ¬ï¼Œæ•¬è¯·æœŸå¾…ã€‚<br>æœ¬æ–‡å°†ä»‹ç»C++11çš„å¦ä¸€å¤§ç‰¹æ€§ï¼šå¼‚æ­¥è¿è¡Œ(std::async)ã€‚asyncé¡¾åæ€ä¹‰æ˜¯å°†ä¸€ä¸ªå‡½æ•°Aç§»è‡³å¦ä¸€çº¿ç¨‹ä¸­å»è¿è¡Œã€‚Aå¯ä»¥æ˜¯é™æ€å‡½æ•°ã€å…¨å±€å‡½æ•°ï¼Œç”šè‡³ç±»æˆå‘˜å‡½æ•°ã€‚åœ¨å¼‚æ­¥è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœAéœ€è¦å‘è°ƒç”¨è€…è¾“å‡ºç»“æœæ€ä¹ˆåŠå‘¢ï¼Ÿstd::asyncå®Œç¾è§£å†³äº†è¿™ä¸€é—®é¢˜ã€‚åœ¨äº†è§£asyncçš„è§£å†³ä¹‹é“å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›çŸ¥è¯†å‚¨å¤‡ï¼Œé‚£å°±æ˜¯ï¼šstd::promiseã€std::packaged_taskå’Œstd::futureã€‚å¼‚æ­¥è¿è¡Œæ¶‰åŠçš„å†…å®¹è¾ƒå¤šï¼Œæˆ‘ä»¬ä¼šåˆ†å‡ èŠ‚æ¥è®²ã€‚</p>
<p>std::promiseæ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»: template<typename r> class promiseã€‚å…¶æ³›å‹å‚æ•°Rä¸ºstd::promiseå¯¹è±¡ä¿å­˜çš„å€¼çš„ç±»å‹ï¼ŒRå¯ä»¥æ˜¯voidç±»å‹ã€‚std::promiseä¿å­˜çš„å€¼å¯è¢«ä¸ä¹‹å…³è”çš„std::futureè¯»å–ï¼Œè¯»å–æ“ä½œå¯ä»¥å‘ç”Ÿåœ¨å…¶å®ƒçº¿ç¨‹ã€‚std::promiseå…è®¸moveè¯­ä¹‰(å³å€¼æ„é€ ï¼Œå³å€¼èµ‹å€¼)ï¼Œä½†ä¸å…è®¸æ‹·è´(æ‹·è´æ„é€ ã€èµ‹å€¼)ï¼Œstd::futureäº¦ç„¶ã€‚std::promiseå’Œstd::futureåˆä½œå…±åŒå®ç°äº†å¤šçº¿ç¨‹é—´é€šä¿¡ã€‚</typename></p>
<h2 id="4-1-è®¾ç½®std-promiseçš„å€¼"><a href="#4-1-è®¾ç½®std-promiseçš„å€¼" class="headerlink" title="4.1 è®¾ç½®std::promiseçš„å€¼"></a>4.1 è®¾ç½®std::promiseçš„å€¼</h2><p>é€šè¿‡æˆå‘˜å‡½æ•°set_valueå¯ä»¥è®¾ç½®std::promiseä¸­ä¿å­˜çš„å€¼ï¼Œè¯¥å€¼æœ€ç»ˆä¼šè¢«ä¸ä¹‹å…³è”çš„std::future::getè¯»å–åˆ°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šset_valueåªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå¤šæ¬¡è°ƒç”¨ä¼šæŠ›å‡ºstd::future_errorå¼‚å¸¸ã€‚äº‹å®ä¸Šstd::promise::set_xxxå‡½æ•°ä¼šæ”¹å˜std::promiseçš„çŠ¶æ€ä¸ºreadyï¼Œå†æ¬¡è°ƒç”¨æ—¶å‘ç°çŠ¶æ€å·²è¦æ˜¯redayäº†ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span> </span><span class="token comment" spellcheck="true">// std::cout, std::endl</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread></span>   </span><span class="token comment" spellcheck="true">// std::thread</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string></span>   </span><span class="token comment" spellcheck="true">// std::string</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;future></span>   </span><span class="token comment" spellcheck="true">// std::promise, std::future</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;chrono></span>   </span><span class="token comment" spellcheck="true">// seconds</span>
using namespace std<span class="token punctuation">:</span><span class="token punctuation">:</span>chrono<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>future<span class="token operator">&lt;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>string<span class="token operator">></span> <span class="token operator">*</span>future<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// futureä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æœ‰å€¼åˆ°æ¥</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> future<span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// promise ç›¸å½“äºç”Ÿäº§è€…</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>promise<span class="token operator">&lt;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>string<span class="token operator">></span> promise<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// future ç›¸å½“äºæ¶ˆè´¹è€…, å³å€¼æ„é€ </span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>future<span class="token operator">&lt;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>string<span class="token operator">></span> future <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// å¦ä¸€çº¿ç¨‹ä¸­é€šè¿‡futureæ¥è¯»å–promiseçš„å€¼</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread <span class="token function">thread</span><span class="token punctuation">(</span>read<span class="token punctuation">,</span> <span class="token operator">&amp;</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// è®©readç­‰ä¸€ä¼šå„¿:)</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>this_thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sleep_for</span><span class="token punctuation">(</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// </span>
    promise<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token string">"hello future"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæˆ</span>
    thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// æ§åˆ¶å°è¾“: hello future</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸std::promiseå…³è”çš„std::futureæ˜¯é€šè¿‡std::promise::get_futureè·å–åˆ°çš„ï¼Œè‡ªå·±æ„é€ å‡ºæ¥çš„æ— æ•ˆã€‚ä¸€ä¸ªstd::promiseå®ä¾‹åªèƒ½ä¸ä¸€ä¸ªstd::futureå…³è”å…±äº«çŠ¶æ€ï¼Œå½“åœ¨åŒä¸€ä¸ªstd::promiseä¸Šåå¤è°ƒç”¨get_futureä¼šæŠ›å‡ºfuture_errorå¼‚å¸¸ã€‚<br>å…±äº«çŠ¶æ€ã€‚åœ¨std::promiseæ„é€ æ—¶ï¼Œstd::promiseå¯¹è±¡ä¼šä¸å…±äº«çŠ¶æ€å…³è”èµ·æ¥ï¼Œè¿™ä¸ªå…±äº«çŠ¶æ€å¯ä»¥å­˜å‚¨ä¸€ä¸ªRç±»å‹çš„å€¼æˆ–è€…ä¸€ä¸ªç”±std::exceptionæ´¾ç”Ÿå‡ºæ¥çš„å¼‚å¸¸å€¼ã€‚é€šè¿‡std::promise::get_futureè°ƒç”¨è·å¾—çš„std::futureä¸std::promiseå…±äº«ç›¸åŒçš„å…±äº«çŠ¶æ€ã€‚</p>
<h2 id="4-2-å½“std-promiseä¸è®¾ç½®å€¼æ—¶"><a href="#4-2-å½“std-promiseä¸è®¾ç½®å€¼æ—¶" class="headerlink" title="4.2 å½“std::promiseä¸è®¾ç½®å€¼æ—¶"></a>4.2 å½“std::promiseä¸è®¾ç½®å€¼æ—¶</h2><p>å¦‚æœpromiseç›´åˆ°é”€æ¯æ—¶ï¼Œéƒ½æœªè®¾ç½®è¿‡ä»»ä½•å€¼ï¼Œåˆ™promiseä¼šåœ¨ææ„æ—¶è‡ªåŠ¨è®¾ç½®ä¸ºstd::future_errorï¼Œè¿™ä¼šé€ æˆstd::future.getæŠ›å‡ºstd::future_errorå¼‚å¸¸ã€‚</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span> </span><span class="token comment" spellcheck="true">// std::cout, std::endl</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread></span>   </span><span class="token comment" spellcheck="true">// std::thread</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;future></span>   </span><span class="token comment" spellcheck="true">// std::promise, std::future</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;chrono></span>   </span><span class="token comment" spellcheck="true">// seconds</span>
using namespace std<span class="token punctuation">:</span><span class="token punctuation">:</span>chrono<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>future<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> future<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    try <span class="token punctuation">{</span>
        future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token function">catch</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>future_error <span class="token operator">&amp;</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token punctuation">:</span><span class="token punctuation">:</span>cerr <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span> <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread thread<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¦‚æœpromiseä¸è®¾ç½®ä»»ä½•å€¼</span>
        <span class="token comment" spellcheck="true">// åˆ™åœ¨promiseææ„æ—¶ä¼šè‡ªåŠ¨è®¾ç½®ä¸ºfuture_error</span>
        <span class="token comment" spellcheck="true">// è¿™ä¼šé€ æˆfuture.getæŠ›å‡ºè¯¥å¼‚å¸¸</span>
        std<span class="token punctuation">:</span><span class="token punctuation">:</span>promise<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> promise<span class="token punctuation">;</span>
        thread <span class="token operator">=</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">thread</span><span class="token punctuation">(</span>read<span class="token punctuation">,</span> promise<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>future:4
The associated promise has been destructed prior to the associated state becoming ready.</code></pre><h2 id="4-3-é€šè¿‡std-promiseè®©std-futureæŠ›å‡ºå¼‚å¸¸"><a href="#4-3-é€šè¿‡std-promiseè®©std-futureæŠ›å‡ºå¼‚å¸¸" class="headerlink" title="4.3 é€šè¿‡std::promiseè®©std::futureæŠ›å‡ºå¼‚å¸¸"></a>4.3 é€šè¿‡std::promiseè®©std::futureæŠ›å‡ºå¼‚å¸¸</h2><p>é€šè¿‡std::promise::set_exceptionå‡½æ•°å¯ä»¥è®¾ç½®è‡ªå®šä¹‰å¼‚å¸¸ï¼Œè¯¥å¼‚å¸¸æœ€ç»ˆä¼šè¢«ä¼ é€’åˆ°std::futureï¼Œå¹¶åœ¨å…¶getå‡½æ•°ä¸­è¢«æŠ›å‡ºã€‚</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;future></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;exception></span>  </span><span class="token comment" spellcheck="true">// std::make_exception_ptr</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdexcept></span>  </span><span class="token comment" spellcheck="true">// std::logic_error</span>

<span class="token keyword">void</span> <span class="token function">catch_error</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token operator">&amp;</span>future<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    try <span class="token punctuation">{</span>
        future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>logic_error <span class="token operator">&amp;</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token punctuation">:</span><span class="token punctuation">:</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"logic_error: "</span> <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>promise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> promise<span class="token punctuation">;</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> future <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread <span class="token function">thread</span><span class="token punctuation">(</span>catch_error<span class="token punctuation">,</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">ref</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// è‡ªå®šä¹‰å¼‚å¸¸éœ€è¦ä½¿ç”¨make_exception_ptrè½¬æ¢ä¸€ä¸‹</span>
    promise<span class="token punctuation">.</span><span class="token function">set_exception</span><span class="token punctuation">(</span>
        std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">make_exception_ptr</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">logic_error</span><span class="token punctuation">(</span><span class="token string">"caught"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// è¾“å‡ºï¼šlogic_error: caught</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>std::promiseè™½ç„¶æ”¯æŒè‡ªå®šä¹‰å¼‚å¸¸ï¼Œä½†å®ƒå¹¶ä¸ç›´æ¥æ¥å—å¼‚å¸¸å¯¹è±¡ï¼š</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// std::promise::set_exceptionå‡½æ•°åŸå‹</span>
<span class="token keyword">void</span> <span class="token function">set_exception</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>exception_ptr p<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>è‡ªå®šä¹‰å¼‚å¸¸å¯ä»¥é€šè¿‡ä½äºå¤´æ–‡ä»¶exceptionä¸‹çš„std::make_exception_ptrå‡½æ•°è½¬åŒ–ä¸ºstd::exception_ptrã€‚</p>
<h2 id="4-4-std-promise"><a href="#4-4-std-promise" class="headerlink" title="4.4 std::promise"></a>4.4 std::promise<void></void></h2><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬çœ‹åˆ°std::promise<void>æ˜¯åˆæ³•çš„ã€‚æ­¤æ—¶std::promise.set_valueä¸æ¥å—ä»»ä½•å‚æ•°ï¼Œä»…ç”¨äºé€šçŸ¥å…³è”çš„std::future.get()è§£é™¤é˜»å¡ã€‚</void></p>
<h2 id="4-5-std-promiseæ‰€åœ¨çº¿ç¨‹é€€å‡ºæ—¶"><a href="#4-5-std-promiseæ‰€åœ¨çº¿ç¨‹é€€å‡ºæ—¶" class="headerlink" title="4.5 std::promiseæ‰€åœ¨çº¿ç¨‹é€€å‡ºæ—¶"></a>4.5 std::promiseæ‰€åœ¨çº¿ç¨‹é€€å‡ºæ—¶</h2><p>std::async(å¼‚æ­¥è¿è¡Œ)æ—¶ï¼Œå¼€å‘äººå‘˜æœ‰æ—¶ä¼šå¯¹std::promiseæ‰€åœ¨çº¿ç¨‹é€€å‡ºæ—¶é—´æ¯”è¾ƒå…³æ³¨ã€‚std::promiseæ”¯æŒå®šåˆ¶çº¿ç¨‹é€€å‡ºæ—¶çš„è¡Œä¸ºï¼š</p>
<p>std::promise::set_value_at_thread_exit çº¿ç¨‹é€€å‡ºæ—¶ï¼Œstd::futureæ”¶åˆ°é€šè¿‡è¯¥å‡½æ•°è®¾ç½®çš„å€¼ã€‚<br>std::promise::set_exception_at_thread_exit çº¿ç¨‹é€€å‡ºæ—¶ï¼Œstd::futureåˆ™æŠ›å‡ºè¯¥å‡½æ•°æŒ‡å®šçš„å¼‚å¸¸ã€‚<br>å…³äºstd::promiseå°±æ˜¯è¿™äº›ï¼Œæœ¬æ–‡ä»ä½¿ç”¨è§’åº¦ä»‹ç»äº†std::promiseçš„èƒ½åŠ›ä»¥åŠè¾¹ç•Œï¼Œè¯»è€…å¦‚æœæƒ³æ›´æ·±å…¥äº†è§£è¯¥ç±»ï¼Œå¯ä»¥ç›´æ¥é˜…è¯»ä¸€ä¸‹æºç ã€‚</p>
<h1 id="äº”ã€å¼‚æ­¥è¿è¡Œä¹‹std-packaged-task"><a href="#äº”ã€å¼‚æ­¥è¿è¡Œä¹‹std-packaged-task" class="headerlink" title="äº”ã€å¼‚æ­¥è¿è¡Œä¹‹std::packaged_task"></a>äº”ã€å¼‚æ­¥è¿è¡Œä¹‹std::packaged_task</h1><p>ä¸Šä¸€ç¯‡ä»‹ç»çš„std::promiseé€šè¿‡set_valueå¯ä»¥ä½¿å¾—ä¸ä¹‹å…³è”çš„std::futureè·å–æ•°æ®ã€‚æœ¬ç¯‡ä»‹ç»çš„std::packaged_taskåˆ™æ›´ä¸ºå¼ºå¤§ï¼Œå®ƒå…è®¸ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶å°†å‡½æ•°è®¡ç®—çš„ç»“æœä¼ é€’ç»™std::futureï¼ŒåŒ…æ‹¬å‡½æ•°è¿è¡Œæ—¶äº§ç”Ÿçš„å¼‚å¸¸ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹å®ƒã€‚</p>
<p>åœ¨å¼€å§‹std::packaged_taskä¹‹å‰æˆ‘ä»¬å…ˆçœ‹ä¸€æ®µä»£ç ï¼Œå¯¹std::packaged_taskæœ‰ä¸ªç›´è§‚çš„å°è±¡ï¼Œç„¶åæˆ‘ä»¬å†è¿›ä¸€æ­¥ä»‹ç»ã€‚</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread></span>   </span><span class="token comment" spellcheck="true">// std::thread</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;future></span>   </span><span class="token comment" spellcheck="true">// std::packaged_task, std::future</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span> </span><span class="token comment" spellcheck="true">// std::cout</span>

<span class="token keyword">int</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>packaged_task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token function">task</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>future<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> future <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// std::promiseä¸€æ ·ï¼Œstd::packaged_taskæ”¯æŒmoveï¼Œä½†ä¸æ”¯æŒæ‹·è´</span>
    <span class="token comment" spellcheck="true">// std::threadçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸æ­¢æ˜¯å‡½æ•°ï¼Œè¿˜å¯ä»¥æ˜¯ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œå³æ”¯æŒoperator()(Args...)æ“ä½œ</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread <span class="token function">t</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ç­‰å¾…å¼‚æ­¥è®¡ç®—ç»“æœ</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"1 + 2 => "</span> <span class="token operator">&lt;&lt;</span> future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>

    t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/// è¾“å‡º: 1 + 2 => 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>std::packaged_taskä½äºå¤´æ–‡ä»¶#include <future>ä¸­ï¼Œæ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»</future></p>
<pre class="line-numbers language-c"><code class="language-c">template <span class="token operator">&lt;</span>class R<span class="token punctuation">,</span> class<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> ArgTypes<span class="token operator">></span>
class packaged_task<span class="token operator">&lt;</span><span class="token function">R</span><span class="token punctuation">(</span>ArgTypes<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>å…¶ä¸­Ræ˜¯ä¸€ä¸ªå‡½æ•°æˆ–å¯è°ƒç”¨å¯¹è±¡ï¼ŒArgTypesæ˜¯Rçš„å½¢å‚ã€‚ä¸std::promiseä¸€æ ·ï¼Œstd::packaged_taskæ”¯æŒmoveï¼Œä½†ä¸æ”¯æŒæ‹·è´(copy)ã€‚std::packaged_taskå°è£…çš„å‡½æ•°çš„è®¡ç®—ç»“æœä¼šé€šè¿‡ä¸ä¹‹è”ç³»çš„std::future::getè·å–(å½“ç„¶ï¼Œå¯ä»¥åœ¨å…¶å®ƒçº¿ç¨‹ä¸­å¼‚æ­¥è·å–)ã€‚å…³è”çš„std::futureå¯ä»¥é€šè¿‡std::packaged_task::get_futureè·å–åˆ°ï¼Œget_futureä»…èƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¤šæ¬¡è°ƒç”¨ä¼šè§¦å‘std::future_errorå¼‚å¸¸ã€‚<br>std::package_taské™¤äº†å¯ä»¥é€šè¿‡å¯è°ƒç”¨å¯¹è±¡æ„é€ å¤–ï¼Œè¿˜æ”¯æŒç¼ºçœæ„é€ (æ— å‚æ„é€ )ã€‚ä½†æ­¤æ—¶æ„é€ çš„å¯¹è±¡ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€é€šè¿‡å³å€¼èµ‹å€¼æ“ä½œè®¾ç½®äº†å¯è°ƒç”¨å¯¹è±¡æˆ–å‡½æ•°åæ‰å¯ä½¿ç”¨ã€‚åˆ¤æ–­ä¸€ä¸ªstd::packaged_taskæ˜¯å¦å¯ä½¿ç”¨ï¼Œå¯é€šè¿‡å…¶æˆå‘˜å‡½æ•°validæ¥åˆ¤æ–­ã€‚</p>
<h2 id="5-1-std-packaged-task-valid"><a href="#5-1-std-packaged-task-valid" class="headerlink" title="5.1 std::packaged_task::valid"></a>5.1 std::packaged_task::valid</h2><p>è¯¥å‡½æ•°ç”¨äºåˆ¤æ–­std::packaged_taskå¯¹è±¡æ˜¯å¦æ˜¯æœ‰æ•ˆçŠ¶æ€ã€‚å½“é€šè¿‡ç¼ºçœæ„é€ åˆå§‹åŒ–æ—¶ï¼Œç”±äºå…¶æœªè®¾ç½®ä»»ä½•å¯è°ƒç”¨å¯¹è±¡æˆ–å‡½æ•°ï¼Œvalidä¼šè¿”å›falseã€‚åªæœ‰å½“std::packaged_taskè®¾ç½®äº†æœ‰æ•ˆçš„å‡½æ•°æˆ–å¯è°ƒç”¨å¯¹è±¡ï¼Œvalidæ‰è¿”å›trueã€‚</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;future></span>   </span><span class="token comment" spellcheck="true">// std::packaged_task, std::future</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span> </span><span class="token comment" spellcheck="true">// std::cout</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>packaged_task<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> task<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ç¼ºçœæ„é€ ã€é»˜è®¤æ„é€ </span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>boolalpha <span class="token operator">&lt;&lt;</span> task<span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// false</span>

    std<span class="token punctuation">:</span><span class="token punctuation">:</span>packaged_task<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token function">task2</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å³å€¼æ„é€ </span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>boolalpha <span class="token operator">&lt;&lt;</span> task<span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// false</span>

    task <span class="token operator">=</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>packaged_task<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å³å€¼èµ‹å€¼, å¯è°ƒç”¨å¯¹è±¡</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>boolalpha <span class="token operator">&lt;&lt;</span> task<span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>false
false
true</code></pre><h2 id="5-2-std-packaged-task-operator-ArgTypesâ€¦"><a href="#5-2-std-packaged-task-operator-ArgTypesâ€¦" class="headerlink" title="5.2 std::packaged_task::operator()(ArgTypesâ€¦)"></a>5.2 std::packaged_task::operator()(ArgTypesâ€¦)</h2><p>è¯¥å‡½æ•°ä¼šè°ƒç”¨std::packaged_taskå¯¹è±¡æ‰€å°è£…å¯è°ƒç”¨å¯¹è±¡Rï¼Œä½†å…¶å‡½æ•°åŸå‹ä¸Rç¨æœ‰ä¸åŒ:</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ArgTypes<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>operator()çš„è¿”å›å€¼æ˜¯voidï¼Œå³æ— è¿”å›å€¼ã€‚å› ä¸ºstd::packaged_taskçš„è®¾è®¡ä¸»è¦æ˜¯ç”¨æ¥è¿›è¡Œå¼‚æ­¥è°ƒç”¨ï¼Œå› æ­¤R(ArgTypesâ€¦)çš„è®¡ç®—ç»“æœæ˜¯é€šè¿‡std::future::getæ¥è·å–çš„ã€‚è¯¥å‡½æ•°ä¼šå¿ å®åœ°å°†Rçš„è®¡ç®—ç»“æœåé¦ˆç»™std::futureï¼Œå³ä½¿RæŠ›å‡ºå¼‚å¸¸(æ­¤æ—¶std::future::getä¹Ÿä¼šæŠ›å‡ºåŒæ ·çš„å¼‚å¸¸)ã€‚</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;future></span>   </span><span class="token comment" spellcheck="true">// std::packaged_task, std::future</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span> </span><span class="token comment" spellcheck="true">// std::cout</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>packaged_task<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        throw std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">logic_error</span><span class="token punctuation">(</span><span class="token string">"will catch in future"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> future <span class="token operator">=</span> convert<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">convert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å¼‚å¸¸ä¸ä¼šåœ¨æ­¤å¤„æŠ›å‡º</span>

    try <span class="token punctuation">{</span>
        future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token function">catch</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>logic_error <span class="token operator">&amp;</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token punctuation">:</span><span class="token punctuation">:</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token function">typeid</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span> <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/// Clangä¸‹è¾“å‡º: St11logic_error: will catch in future</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸ºäº†å¸®å¿™å¤§å®¶æ›´å¥½çš„äº†è§£è¯¥å‡½æ•°ï¼Œä¸‹é¢å°†Clangä¸‹ç²¾ç®€è¿‡çš„operator()(Argsâ€¦)çš„å®ç°è´´å‡ºï¼Œä»¥ä¾¿äºæ›´å¥½ç†è§£è¯¥å‡½æ•°çš„è¾¹ç•Œï¼Œæ˜ç¡®ä»€ä¹ˆå¯ä»¥åšï¼Œä»€ä¹ˆä¸å¯ä»¥åšã€‚</p>
<pre class="line-numbers language-c"><code class="language-c">template<span class="token operator">&lt;</span>class _Rp<span class="token punctuation">,</span> class <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>_ArgTypes<span class="token operator">></span>
class packaged_task<span class="token operator">&lt;</span><span class="token function">_Rp</span><span class="token punctuation">(</span>_ArgTypes<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    __packaged_task_function<span class="token operator">&lt;</span><span class="token function">_Rp_</span><span class="token punctuation">(</span>_ArgTypes<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token operator">></span> __f_<span class="token punctuation">;</span>
    promise<span class="token operator">&lt;</span>_Rp<span class="token operator">></span> __p_<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å†…éƒ¨é‡‡ç”¨äº†promiseå®ç°</span>

public<span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">// æ„é€ ã€ææ„ä»¥åŠå…¶å®ƒå‡½æ•°...</span>

    <span class="token keyword">void</span> packaged_task<span class="token operator">&lt;</span><span class="token function">_Rp</span><span class="token punctuation">(</span>_ArgTypes<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_ArgTypes<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> __args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__p_<span class="token punctuation">.</span>__state_ <span class="token operator">==</span> nullptr<span class="token punctuation">)</span>
            <span class="token function">__throw_future_error</span><span class="token punctuation">(</span>future_errc<span class="token punctuation">:</span><span class="token punctuation">:</span>no_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__p_<span class="token punctuation">.</span>__state_<span class="token operator">-></span><span class="token function">__has_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// __f_ä¸å¯é‡å¤è°ƒç”¨</span>
            <span class="token function">__throw_future_error</span><span class="token punctuation">(</span>future_errc<span class="token punctuation">:</span><span class="token punctuation">:</span>promise_already_satisfied<span class="token punctuation">)</span><span class="token punctuation">;</span>

        try <span class="token punctuation">{</span>
            __p_<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token function">__f_</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>forward<span class="token operator">&lt;</span>_ArgTypes<span class="token operator">></span><span class="token punctuation">(</span>__args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            __p_<span class="token punctuation">.</span><span class="token function">set_exception</span><span class="token punctuation">(</span><span class="token function">current_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="5-3-è®©std-packaged-taskåœ¨çº¿ç¨‹é€€å‡ºæ—¶å†å°†ç»“æœåé¦ˆç»™std-future"><a href="#5-3-è®©std-packaged-taskåœ¨çº¿ç¨‹é€€å‡ºæ—¶å†å°†ç»“æœåé¦ˆç»™std-future" class="headerlink" title="5.3 è®©std::packaged_taskåœ¨çº¿ç¨‹é€€å‡ºæ—¶å†å°†ç»“æœåé¦ˆç»™std::future"></a>5.3 è®©std::packaged_taskåœ¨çº¿ç¨‹é€€å‡ºæ—¶å†å°†ç»“æœåé¦ˆç»™std::future</h2><p>std::packaged_task::make_ready_at_thread_exitå‡½æ•°æ¥æ”¶çš„å‚æ•°ä¸operator()(_ArgTypesâ€¦)ä¸€æ ·ï¼Œè¡Œä¸ºä¹Ÿä¸€æ ·ã€‚åªæœ‰ä¸€ç‚¹å·®åˆ«ï¼Œé‚£å°±æ˜¯ä¸ä¼šå°†è®¡ç®—ç»“æœç«‹åˆ»åé¦ˆç»™std::futureï¼Œè€Œæ˜¯åœ¨å…¶æ‰§è¡Œæ—¶æ‰€åœ¨çš„çº¿ç¨‹ç»“æŸåï¼Œstd::future::getæ‰ä¼šå–å¾—ç»“æœã€‚</p>
<h2 id="5-4-std-packaged-task-reset"><a href="#5-4-std-packaged-task-reset" class="headerlink" title="5.4  std::packaged_task::reset"></a>5.4  std::packaged_task::reset</h2><p>ä¸std::promiseä¸ä¸€æ ·ï¼Œ std::promiseä»…å¯ä»¥æ‰§è¡Œä¸€æ¬¡set_valueæˆ–set_exceptionå‡½æ•°ï¼Œä½†std::packagged_taskå¯ä»¥æ‰§è¡Œå¤šæ¬¡ï¼Œå…¶å¥¥ç§˜å°±æ˜¯resetå‡½æ•°</p>
<pre class="line-numbers language-c"><code class="language-c">template<span class="token operator">&lt;</span>class _Rp<span class="token punctuation">,</span> class <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>_ArgTypes<span class="token operator">></span>
<span class="token keyword">void</span> packaged_task<span class="token operator">&lt;</span><span class="token function">_Rp</span><span class="token punctuation">(</span>_ArgTypes<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">__throw_future_error</span><span class="token punctuation">(</span>future_errc<span class="token punctuation">:</span><span class="token punctuation">:</span>no_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __p_ <span class="token operator">=</span> promise<span class="token operator">&lt;</span>result_type<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€šè¿‡é‡æ–°æ„é€ ä¸€ä¸ªpromiseæ¥è¾¾åˆ°å¤šæ¬¡è°ƒç”¨çš„ç›®çš„ã€‚æ˜¾ç„¶è°ƒç”¨resetåï¼Œéœ€è¦é‡æ–°get_futureï¼Œä»¥ä¾¿è·å–ä¸‹æ¬¡operator()æ‰§è¡Œçš„ç»“æœã€‚ç”±äºæ˜¯é‡æ–°æ„é€ äº†promiseï¼Œå› æ­¤resetæ“ä½œå¹¶ä¸ä¼šå½±å“ä¹‹å‰è°ƒç”¨çš„make_ready_at_thread_exitç»“æœï¼Œä¹Ÿå³ä¹‹å‰çš„å®šåˆ¶çš„è¡Œä¸ºåœ¨çº¿ç¨‹é€€å‡ºæ—¶ä»ä¼šå‘ç”Ÿã€‚</p>
<p>std::packaged_taskå°±ä»‹ç»åˆ°è¿™é‡Œï¼Œä¸‹ä¸€ç¯‡å°†ä¼šå®Œæˆæœ¬æ¬¡å¼‚æ­¥è¿è¡Œçš„æ•´ä½“è„‰ç»œï¼Œå°†std::asyncå’Œstd::futureä¸€èµ·ä»‹ç»ç»“å¤§å®¶ã€‚</p>
<h1 id="å…­ã€å¼‚æ­¥è¿è¡Œä¹‹æœ€ç»ˆç¯‡-future-async"><a href="#å…­ã€å¼‚æ­¥è¿è¡Œä¹‹æœ€ç»ˆç¯‡-future-async" class="headerlink" title="å…­ã€å¼‚æ­¥è¿è¡Œä¹‹æœ€ç»ˆç¯‡(future+async)"></a>å…­ã€å¼‚æ­¥è¿è¡Œä¹‹æœ€ç»ˆç¯‡(future+async)</h1><p>å‰é¢ä¸¤ç« å¤šæ¬¡ä½¿ç”¨åˆ°std::futureï¼Œæœ¬ç« æˆ‘ä»¬å°±æ¥æ­å¼€std::futureåºå±±çœŸé¢ç›®ã€‚æœ€åæˆ‘ä»¬ä¼šå¼•å‡ºstd::asyncï¼Œè¯¥å‡½æ•°ä½¿å¾—æˆ‘ä»¬çš„å¹¶å‘è°ƒç”¨å˜å¾—ç®€å•ï¼Œä¼˜é›…ã€‚<br>å‰é¢æˆ‘ä»¬å¤šæ¬¡ä½¿ç”¨std::futureçš„getæ–¹æ³•æ¥è·å–å…¶å®ƒçº¿ç¨‹çš„ç»“æœï¼Œé‚£ä¹ˆé™¤è¿™ä¸ªæ–¹æ³•å¤–ï¼Œstd::futureè¿˜æœ‰å“ªäº›æ–¹æ³•å‘¢ã€‚</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">enum</span> class future_status
<span class="token punctuation">{</span>
    ready<span class="token punctuation">,</span>
    timeout<span class="token punctuation">,</span>
    deferred
<span class="token punctuation">}</span><span class="token punctuation">;</span>
template <span class="token operator">&lt;</span>class R<span class="token operator">></span>
class future
<span class="token punctuation">{</span>
public<span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">// retrieving the value</span>
    R <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// functions to check state</span>
    bool <span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> noexcept<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
    template <span class="token operator">&lt;</span>class Rep<span class="token punctuation">,</span> class Period<span class="token operator">></span>
    future_status <span class="token function">wait_for</span><span class="token punctuation">(</span><span class="token keyword">const</span> chrono<span class="token punctuation">:</span><span class="token punctuation">:</span>duration<span class="token operator">&lt;</span>Rep<span class="token punctuation">,</span> Period<span class="token operator">></span><span class="token operator">&amp;</span> rel_time<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
    template <span class="token operator">&lt;</span>class Clock<span class="token punctuation">,</span> class Duration<span class="token operator">></span>
    future_status <span class="token function">wait_until</span><span class="token punctuation">(</span><span class="token keyword">const</span> chrono<span class="token punctuation">:</span><span class="token punctuation">:</span>time_point<span class="token operator">&lt;</span>Clock<span class="token punctuation">,</span> Duration<span class="token operator">></span><span class="token operator">&amp;</span> abs_time<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

    shared_future<span class="token operator">&lt;</span>R<span class="token operator">></span> <span class="token function">share</span><span class="token punctuation">(</span><span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»¥ä¸Šä»£ç å»æ‰äº†std::futureæ„é€ ã€ææ„ã€èµ‹å€¼ç›¸å…³çš„ä»£ç ï¼Œè¿™äº›çº¦æŸæˆ‘ä»¬ä¹‹å‰éƒ½è®²è¿‡äº†ã€‚ä¸‹é¢æˆ‘ä»¬æ¥é€ä¸€äº†è§£ä¸Šé¢è¿™äº›å‡½æ•°ã€‚</p>
<h2 id="6-1-get"><a href="#6-1-get" class="headerlink" title="6.1 get"></a>6.1 get</h2><p>è¿™ä¸ªå‡½æ•°æˆ‘ä»¬ä¹‹å‰ä¸€ç›´ä½¿ç”¨ï¼Œè¯¥å‡½æ•°ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°è·å–åˆ°ç»“æœæˆ–å¼‚æ­¥ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<h2 id="6-2-share"><a href="#6-2-share" class="headerlink" title="6.2 share"></a>6.2 share</h2><p>std::futureå…è®¸moveï¼Œä½†æ˜¯ä¸å…è®¸æ‹·è´ã€‚å¦‚æœç”¨æˆ·ç¡®æœ‰è¿™ç§éœ€æ±‚ï¼Œéœ€è¦åŒæ—¶æŒæœ‰å¤šä¸ªå®ä¾‹ï¼Œæ€ä¹ˆåŠå‘¢? è¿™å°±æ˜¯shareå‘æŒ¥ä½œç”¨çš„æ—¶å€™äº†ã€‚std::shared_futureé€šè¿‡å¼•ç”¨è®¡æ•°çš„æ–¹å¼å®ç°äº†å¤šå®ä¾‹å…±äº«åŒä¸€çŠ¶æ€ï¼Œä½†æœ‰è®¡æ•°å°±ä¼´éšç€åŒæ­¥å¼€é”€(æ— é”çš„åŸå­æ“ä½œä¹Ÿæ˜¯æœ‰å¼€é”€çš„)ï¼Œæ€§èƒ½ä¼šç¨æœ‰ä¸‹é™ã€‚å› æ­¤C++11è¦æ±‚ç¨‹åºå‘˜æ˜¾å¼è°ƒç”¨è¯¥å‡½æ•°ï¼Œä»¥è¡¨æ˜ç”¨æˆ·å¯¹ç”±æ­¤å¸¦æ¥çš„å¼€é”€è´Ÿè´£ã€‚std::shared_futureå…è®¸moveï¼Œå…è®¸æ‹·è´ï¼Œå¹¶ä¸”å…·æœ‰å’Œstd::futureåŒæ ·çš„æˆå‘˜å‡½æ•°ï¼Œæ­¤å¤„å°±ä¸ä¸€ä¸€ä»‹ç»äº†ã€‚å½“è°ƒç”¨shareåï¼Œstd::futureå¯¹è±¡å°±ä¸å†å’Œä»»ä½•å…±äº«çŠ¶æ€å…³è”ï¼Œå…¶validå‡½æ•°ä¹Ÿä¼šå˜ä¸ºfalseã€‚</p>
<h2 id="6-3-wait"><a href="#6-3-wait" class="headerlink" title="6.3 wait"></a>6.3 wait</h2><p>ç­‰å¾…ï¼Œç›´åˆ°æ•°æ®å°±ç»ªã€‚æ•°æ®å°±ç»ªæ—¶ï¼Œé€šè¿‡getå‡½æ•°ï¼Œæ— ç­‰å¾…å³å¯è·å¾—æ•°æ®ã€‚</p>
<h2 id="6-4-wait-forå’Œwait-until"><a href="#6-4-wait-forå’Œwait-until" class="headerlink" title="6.4 wait_forå’Œwait_until"></a>6.4 wait_forå’Œwait_until</h2><p>wait_forã€wait_untilä¸»è¦æ˜¯ç”¨æ¥è¿›è¡Œè¶…æ—¶ç­‰å¾…çš„ã€‚wait_forç­‰å¾…æŒ‡å®šæ—¶é•¿ï¼Œwait_untilåˆ™ç­‰å¾…åˆ°æŒ‡å®šçš„æ—¶é—´ç‚¹ã€‚è¿”å›å€¼æœ‰3ç§çŠ¶æ€ï¼š</p>
<ul>
<li>ready - æ•°æ®å·²å°±ç»ªï¼Œå¯ä»¥é€šè¿‡getè·å–äº†ã€‚</li>
<li>timeout - è¶…æ—¶ï¼Œæ•°æ®è¿˜æœªå‡†å¤‡å¥½ã€‚</li>
<li>deferred - è¿™ä¸ªå’Œstd::asyncç›¸å…³ï¼Œè¡¨æ˜æ— éœ€waitï¼Œå¼‚æ­¥å‡½æ•°å°†åœ¨getæ—¶æ‰§è¡Œã€‚</li>
</ul>
<h2 id="6-5-valid"><a href="#6-5-valid" class="headerlink" title="6.5 valid"></a>6.5 valid</h2><p>åˆ¤æ–­å½“å‰std::futureå®ä¾‹æ˜¯å¦æœ‰æ•ˆã€‚std::futureä¸»è¦æ˜¯ç”¨æ¥è·å–å¼‚æ­¥ä»»åŠ¡ç»“æœçš„ï¼Œä½œä¸ºæ¶ˆè´¹æ–¹å‡ºç°ï¼Œå•ç‹¬æ„å»ºå‡ºæ¥çš„å®ä¾‹æ²¡æ„ä¹‰ï¼Œå› æ­¤å…¶validä¸ºfalseã€‚å½“ä¸å…¶å®ƒç”Ÿäº§æ–¹(Provider)é€šè¿‡å…±äº«çŠ¶æ€å…³è”åï¼Œvalidæ‰ä¼šå˜å¾—æœ‰æ•ˆï¼Œstd::futureæ‰ä¼šå‘æŒ¥å®é™…çš„ä½œç”¨ã€‚C++11ä¸­æœ‰ä¸‹é¢å‡ ç§Providerï¼Œä»è¿™äº›Providerå¯è·å¾—æœ‰æ•ˆçš„std::futureå®ä¾‹ï¼š</p>
<ul>
<li>std::async</li>
<li>std::promise::get_future</li>
<li>std::packaged_task::get_future<br>æ—¢ç„¶std::futureçš„å„ç§è¡Œä¸ºéƒ½ä¾èµ–å…±äº«çŠ¶æ€ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯å…±äº«çŠ¶æ€å‘¢?<h1 id="ä¸ƒã€å…±äº«çŠ¶æ€"><a href="#ä¸ƒã€å…±äº«çŠ¶æ€" class="headerlink" title="ä¸ƒã€å…±äº«çŠ¶æ€"></a>ä¸ƒã€å…±äº«çŠ¶æ€</h1>å…±äº«çŠ¶æ€å…¶æœ¬è´¨å°±æ˜¯å•ç”Ÿäº§è€…-å•æ¶ˆè´¹è€…çš„å¤šçº¿ç¨‹å¹¶å‘æ¨¡å‹ã€‚æ— è®ºæ˜¯std::promiseè¿˜æ˜¯std::packaged_taskéƒ½æ˜¯é€šè¿‡å…±äº«çŠ¶æ€ï¼Œå®ç°ä¸std::futureé€šä¿¡çš„ã€‚è¿˜è®°å¾—æˆ‘ä»¬åœ¨std::condition_variableä¸€èŠ‚ç»™å‡ºçš„chanç±»ä¹ˆã€‚å…±äº«çŠ¶æ€ä¸å…¶ç±»ä¼¼ï¼Œé€šè¿‡std::mutexã€std::condition_variableå®ç°äº†å¤šçº¿ç¨‹é—´é€šä¿¡ã€‚å…±äº«çŠ¶æ€å¹¶éC++11çš„æ ‡å‡†ï¼Œåªæ˜¯å¯¹std::promiseã€std::futureçš„å®ç°æ‰‹æ®µã€‚å›æƒ³æˆ‘ä»¬ä¹‹å‰çš„ä½¿ç”¨åœºæ™¯ï¼Œå…±äº«çŠ¶æ€å¯èƒ½å…·æœ‰å¦‚ä¸‹å½¢å¼(c++11ä¼ªä»£ç ):<pre class="line-numbers language-c"><code class="language-c">template<span class="token operator">&lt;</span>typename T<span class="token operator">></span>
class assoc_state <span class="token punctuation">{</span>
protected<span class="token punctuation">:</span>
  mutable mutex mut_<span class="token punctuation">;</span>
  mutable condition_variable cv_<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> state_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// std::shared_futureä¸­æ‹·è´åŠ¨ä½œä¼šå‘ç”Ÿå¼•ç”¨è®¡æ•°çš„å˜åŒ–</span>
  <span class="token comment" spellcheck="true">// å½“å¼•ç”¨è®¡æ•°é™åˆ°0æ—¶ï¼Œå®ä¾‹è¢«delete</span>
  <span class="token keyword">int</span> share_count_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  exception_ptr exception_<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// æ‰§è¡Œå¼‚å¸¸</span>
  T value_<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// æ‰§è¡Œç»“æœ</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>public:<br>    enum {<br>        ready = 4,  // å¼‚æ­¥åŠ¨ä½œæ‰§è¡Œå®Œï¼Œæ•°æ®å°±ç»ª<br>        // å¼‚æ­¥åŠ¨ä½œå°†å»¶è¿Ÿåˆ°future.get()æ—¶è°ƒç”¨<br>        // (å®é™…ä¸Šéå¼‚æ­¥ï¼Œåªä¸è¿‡æ˜¯å»¶è¿Ÿæ‰§è¡Œ)<br>        deferred = 8,<br>    };</p>
<pre><code>assoc_state() {}
// ç¦æ­¢æ‹·è´
assoc_state(const assoc_state &amp;) = delete;
assoc_state &amp;operator=(const assoc_state &amp;) = delete;
// ç¦æ­¢move
assoc_state(assoc_state &amp;&amp;) = delete;
assoc_state &amp;operator=(assoc_state &amp;&amp;) = delete;

void set_value(const T &amp;);
void set_exception(exception_ptr p);
// éœ€è¦ç”¨åˆ°çº¿ç¨‹å±€å˜å­˜å‚¨
void set_value_at_thread_exit(const T &amp;);
void set_exception_at_thread_exit(exception_ptr p);

void wait();
future_status wait_for(const duration &amp;) const;
future_status wait_until(const time_point &amp;) const;

T &amp;get() {
    unique_lock&lt;mutex&gt; lock(this-&gt;mut_);
    // å½“_stateä¸ºdeferredæ—¶ï¼Œstd::asyncä¸­
    // çš„å‡½æ•°å°†åœ¨sub_waitä¸­è°ƒç”¨
    this-&gt;sub_wait(lock);
    if (this-&gt;_exception != nullptr)
        rethrow_exception(this-&gt;_exception);
    return _value;
}</code></pre><p>private:<br>    void sub_wait(unique_lock<mutex> &amp;lk) {<br>        if (state_ != ready) {<br>            if (state_ &amp; static_cast<unsigned>(deferred)) {<br>                state_ &amp;= ~static_cast<unsigned>(deferred);<br>                lk.unlock();<br>                <em>_execute();  // æ­¤å¤„æ‰§è¡Œå®é™…çš„å‡½æ•°è°ƒç”¨<br>            } else {<br>                cv</em>.wait(lk, <a href>this</a>{return state == ready;})<br>            }<br>        }<br>    }<br>};</unsigned></unsigned></mutex></p>
<pre><code>ä»¥ä¸Šç»™å‡ºäº†getçš„å®ç°(ä¼ªä»£ç )ï¼Œå…¶å®ƒéƒ¨åˆ†è™½ç„¶æ²¡å®ç°ï¼Œä½†assoc_stateåº”è¯¥å…·æœ‰çš„åŠŸèƒ½ï¼Œä»¥åŠå¯¹std::promiseã€std::packaged_taskã€std::futureã€std::shared_futureçš„æ”¯æ’‘åº”è¯¥èƒ½å¤Ÿè¡¨è¾¾æ¸…æ¥šäº†ã€‚æœªå®ç°éƒ¨åˆ†è¿˜è¯·è¯»è€…è‡ªè¡Œè¡¥å……ä¸€ä¸‹ï¼Œæƒå½“æ˜¯ç»ƒæ‰‹äº†ã€‚
æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»[llvm-libxx](https://github.com/llvm-mirror/libcxx)([https://github.com/llvm-mirror/libcxx](https://github.com/llvm-mirror/libcxx))çš„æºç ï¼Œä»¥äº†è§£æ›´å¤šç»†èŠ‚ï¼Œå¯¹å…±äº«çŠ¶æ€æœ‰æ›´æ·±æŒæ¡ã€‚
# ä¹ã€std::async
std::asyncå¯ä»¥çœ‹ä½œæ˜¯å¯¹std::packaged_taskçš„å°è£…(è™½ç„¶å®é™…å¹¶ä¸€å®šå¦‚æ­¤ï¼Œå–å†³äºç¼–è¯‘å™¨çš„å®ç°ï¼Œä½†å…±äº«çŠ¶æ€çš„æ€æƒ³æ˜¯ä¸å˜çš„)ï¼Œæœ‰ä¸¤ç§é‡è½½å½¢å¼:
```c
#define FR typename result_of&lt;typename decay&lt;F&gt;::type(typename decay&lt;Args&gt;::type...)&gt;::type

// ä¸å«æ‰§è¡Œç­–ç•¥
template &lt;class F, class... Args&gt;
future&lt;FR&gt; async(F&amp;&amp; f, Args&amp;&amp;... args);
// å«æ‰§è¡Œç­–ç•¥
template &lt;class F, class... Args&gt;
future&lt;FR&gt; async(launch policy, F&amp;&amp; f, Args&amp;&amp;... args);</code></pre><p>defineéƒ¨åˆ†æ˜¯ç”¨æ¥æ¨æ–­å‡½æ•°Fçš„è¿”å›å€¼ç±»å‹ï¼Œæˆ‘ä»¬å…ˆå¿½ç•¥å®ƒï¼Œä»¥åæœ‰æœºå†è®²ã€‚ä¸¤ä¸ªé‡è½½å½¢å¼çš„å·®åˆ«æ˜¯ä¸€ä¸ªå«æ‰§è¡Œç­–ç•¥ï¼Œè€Œå¦ä¸€ä¸ªä¸å«ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯æ‰§è¡Œç­–ç•¥å‘¢ï¼Ÿæ‰§è¡Œç­–ç•¥å®šä¹‰äº†asyncæ‰§è¡ŒF(å‡½æ•°æˆ–å¯è°ƒç”¨æ±‚å¯¹è±¡)çš„æ–¹å¼ï¼Œæ˜¯ä¸€ä¸ªæšä¸¾å€¼ï¼š</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">enum</span> class launch <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ä¿è¯å¼‚æ­¥è¡Œä¸ºï¼ŒFå°†åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­æ‰§è¡Œ</span>
    async <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// å½“å…¶å®ƒçº¿ç¨‹è°ƒç”¨std::future::getæ—¶ï¼Œ</span>
    <span class="token comment" spellcheck="true">// å°†è°ƒç”¨éå¼‚æ­¥å½¢å¼, å³Fåœ¨getå‡½æ•°å†…æ‰§è¡Œ</span>
    deferred <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// Fçš„æ‰§è¡Œæ—¶æœºç”±std::asyncæ¥å†³å®š</span>
    any <span class="token operator">=</span> async <span class="token operator">|</span> deferred
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸å«åŠ è½½ç­–ç•¥çš„ç‰ˆæœ¬ï¼Œä½¿ç”¨çš„æ˜¯std::launch::anyï¼Œä¹Ÿå³ç”±std::asyncå‡½æ•°è‡ªè¡Œå†³å®šFçš„æ‰§è¡Œç­–ç•¥ã€‚é‚£ä¹ˆC++11å¦‚ä½•ç¡®å®šstd::anyä¸‹çš„å…·ä½“æ‰§è¡Œç­–ç•¥å‘¢ï¼Œä¸€ç§å¯èƒ½çš„åŠæ³•æ˜¯ï¼šä¼˜å…ˆä½¿ç”¨asyncç­–ç•¥ï¼Œå¦‚æœåˆ›å»ºçº¿ç¨‹å¤±è´¥ï¼Œåˆ™ä½¿ç”¨deferredç­–ç•¥ã€‚å®é™…ä¸Šè¿™ä¹Ÿæ˜¯Clangçš„anyå®ç°æ–¹å¼ã€‚std::asyncçš„å‡ºç°å¤§å¤§å‡è½»äº†å¼‚æ­¥çš„å·¥ä½œé‡ã€‚ä½¿å¾—ä¸€ä¸ªå¼‚æ­¥è°ƒç”¨å¯ä»¥åƒæ‰§è¡Œæ™®é€šå‡½æ•°ä¸€æ ·ç®€å•ã€‚</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span> </span><span class="token comment" spellcheck="true">// std::cout, std::endl</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;future></span>   </span><span class="token comment" spellcheck="true">// std::async, std::future</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;chrono></span>   </span><span class="token comment" spellcheck="true">// seconds</span>
using namespace std<span class="token punctuation">:</span><span class="token punctuation">:</span>chrono<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> print <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> c<span class="token punctuation">;</span>
            std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token punctuation">:</span><span class="token punctuation">:</span>this_thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sleep_for</span><span class="token punctuation">(</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ä¸åŒlaunchç­–ç•¥çš„æ•ˆæœ</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>launch policies<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>launch<span class="token punctuation">:</span><span class="token punctuation">:</span>async<span class="token punctuation">,</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>launch<span class="token punctuation">:</span><span class="token punctuation">:</span>deferred<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>names<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"async   "</span><span class="token punctuation">,</span> <span class="token string">"deferred"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>policies<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>policies<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> names<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span><span class="token punctuation">;</span>
        std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> f1 <span class="token operator">=</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">async</span><span class="token punctuation">(</span>policies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> print<span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> f2 <span class="token operator">=</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">async</span><span class="token punctuation">(</span>policies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> print<span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>async   : +-+-+-+--+-++-+--+-+
deferred: ++++++++++----------</code></pre><p>è¿›è¡Œåˆ°ç°åœ¨ï¼ŒC++11çš„asyncç®—æ˜¯ç»“æŸäº†ï¼Œå°½ç®¡è¿˜ç•™äº†ä¸€äº›ç–‘é—®ï¼Œæ¯”å¦‚å…±äº«çŠ¶æ€å¦‚ä½•å®ç°set_value_at_thread_exitæ•ˆæœã€‚æˆ‘ä»¬å°†ä¼šåœ¨ä¸‹ä¸€ç« èŠ‚ä»‹ç»<a href="https://www.jianshu.com/p/8df45004bbcb" target="_blank" rel="noopener">C++11çš„çº¿ç¨‹å±€éƒ¨å­˜å‚¨</a>ï¼Œé¡ºä¾¿ä¹Ÿè§£ç­”ä¸‹è¯¥ç–‘é—®ã€‚</p>
<h1 id="åã€å±€éƒ¨å­˜å‚¨"><a href="#åã€å±€éƒ¨å­˜å‚¨" class="headerlink" title="åã€å±€éƒ¨å­˜å‚¨"></a>åã€å±€éƒ¨å­˜å‚¨</h1><p>çº¿ç¨‹å±€éƒ¨å­˜å‚¨åœ¨å…¶å®ƒè¯­è¨€ä¸­éƒ½æ˜¯ä»¥åº“çš„å½¢å¼æä¾›çš„(åº“å‡½æ•°æˆ–ç±»)ã€‚ä½†åœ¨C++11ä¸­ä»¥å…³é”®å­—çš„å½¢å¼ï¼Œåšä¸ºä¸€ç§å­˜å‚¨ç±»å‹å‡ºç°ï¼Œç”±æ­¤å¯è§C++11å¯¹çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„é‡è§†ã€‚C++11ä¸­æœ‰å¦‚ä¸‹å‡ ç§å­˜å‚¨ç±»å‹:<br>|åºå·|    ç±»å‹|    å¤‡æ³¨|<br>|:â€”:|:â€”:|:â€”:|<br>|1|    auto    |è¯¥å…³é”®å­—ç”¨äºä¸¤ç§æƒ…å†µï¼š1. å£°æ˜å˜é‡æ—¶ï¼š æ ¹æ®åˆå§‹åŒ–è¡¨è¾¾å¼è‡ªåŠ¨æ¨æ–­å˜é‡ç±»å‹ã€‚2. å£°æ˜å‡½æ•°ä½œä¸ºå‡½æ•°è¿”å›å€¼çš„å ä½ç¬¦ã€‚|<br>|2|    static|    staticå˜é‡åªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œé™¤æ­¤ä¹‹å¤–å®ƒè¿˜æœ‰å¯è§æ€§çš„å±æ€§ï¼š1. staticä¿®é¥°å‡½æ•°å†…çš„â€œå±€éƒ¨â€å˜é‡æ—¶ï¼Œè¡¨æ˜å®ƒä¸éœ€è¦åœ¨è¿›å…¥æˆ–ç¦»å¼€å‡½æ•°æ—¶åˆ›å»ºæˆ–é”€æ¯ã€‚ä¸”ä»…åœ¨å‡½æ•°å†…å¯è§ã€‚2. staticä¿®é¥°å…¨å±€å˜é‡æ—¶ï¼Œè¡¨æ˜è¯¥å˜é‡ä»…åœ¨å½“å‰(å£°æ˜å®ƒçš„)æ–‡ä»¶å†…å¯è§ã€‚3. staticä¿®é¥°ç±»çš„æˆå‘˜å˜é‡æ—¶ï¼Œåˆ™è¯¥å˜é‡è¢«è¯¥ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«.|<br>|3|    register|    å¯„å­˜å™¨å˜é‡ã€‚è¯¥å˜é‡å­˜å‚¨åœ¨CPUå¯„å­˜å™¨ä¸­ï¼Œè€Œä¸æ˜¯RAM(æ ˆæˆ–å †)ä¸­ã€‚è¯¥å˜é‡çš„æœ€å¤§å°ºå¯¸ç­‰äºå¯„å­˜å™¨çš„å¤§å°ã€‚ç”±äºæ˜¯å­˜å‚¨äºå¯„å­˜å™¨ä¸­ï¼Œå› æ­¤ä¸èƒ½å¯¹è¯¥å˜é‡è¿›è¡Œå–åœ°å€æ“ä½œã€‚|<br>|4|    extern|    å¼•ç”¨ä¸€ä¸ªå…¨å±€å˜é‡ã€‚å½“åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€ä¸ªå…¨å±€å˜é‡æ—¶ï¼Œå°±å¯ä»¥åœ¨å…¶å®ƒæ–‡ä»¶ä¸­ä½¿ç”¨externæ¥å£°æ˜å¹¶å¼•ç”¨è¯¥å˜é‡ã€‚|<br>|5|    mutable    |ä»…é€‚ç”¨äºç±»æˆå‘˜å˜é‡ã€‚ä»¥mutableä¿®é¥°çš„æˆå‘˜å˜é‡å¯ä»¥åœ¨constæˆå‘˜å‡½æ•°ä¸­ä¿®æ”¹ã€‚å‚è§ä¸Šä¸€ç« chan.simple.hä¸­å¯¹mutexçš„ä½¿ç”¨ã€‚|<br>|6|    thread_local|    çº¿ç¨‹å‘¨æœŸ|</p>
<p>thread_localä¿®é¥°çš„å˜é‡å…·æœ‰å¦‚ä¸‹ç‰¹æ€§:</p>
<ul>
<li>å˜é‡åœ¨çº¿ç¨‹åˆ›å»ºæ—¶ç”Ÿæˆ(ä¸åŒç¼–è¯‘å™¨å®ç°ç•¥æœ‰å·®å¼‚ï¼Œä½†åœ¨çº¿ç¨‹å†…å˜é‡ç¬¬ä¸€æ¬¡ä½¿ç”¨å‰å¿…ç„¶å·²æ„é€ å®Œæ¯•)ã€‚</li>
<li>çº¿ç¨‹ç»“æŸæ—¶è¢«é”€æ¯(ææ„ï¼Œåˆ©ç”¨ææ„ç‰¹æ€§ï¼Œthread_localå˜é‡å¯ä»¥æ„ŸçŸ¥çº¿ç¨‹é”€æ¯äº‹ä»¶)ã€‚</li>
<li>æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰å…¶è‡ªå·±çš„å˜é‡å‰¯æœ¬ã€‚</li>
<li>thread_localå¯ä»¥å’Œstaticæˆ–externè”åˆä½¿ç”¨ï¼Œè¿™å°†ä¼šå½±å“å˜é‡çš„é“¾æ¥å±æ€§ã€‚<br>ä¸‹é¢ä»£ç æ¼”ç¤ºäº†thread_localå˜é‡åœ¨çº¿ç¨‹ä¸­çš„ç”Ÿå‘½å‘¨æœŸ<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// thread_local.cpp</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>class A {<br>public:<br>  A() {<br>    std::cout &lt;&lt; std::this_thread::get_id()<br>              &lt;&lt; â€œ â€œ &lt;&lt; <strong>FUNCTION</strong><br>              &lt;&lt; â€œ(â€œ &lt;&lt; (void *)this &lt;&lt; â€œ)â€<br>              &lt;&lt; std::endl;<br>  }</p>
<p>  ~A() {<br>    std::cout &lt;&lt; std::this_thread::get_id()<br>              &lt;&lt; â€œ â€œ &lt;&lt; <strong>FUNCTION</strong><br>              &lt;&lt; â€œ(â€œ &lt;&lt; (void *)this &lt;&lt; â€œ)â€<br>              &lt;&lt; std::endl;<br>  }</p>
<p>  // çº¿ç¨‹ä¸­ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨å‰åˆå§‹åŒ–<br>  void doSth() {<br>  }<br>};</p>
<p>thread_local A a;</p>
<p>int main() {<br>  a.doSth();<br>  std::thread t(<a href></a> {<br>    std::cout &lt;&lt; â€œThread: â€œ<br>              &lt;&lt; std::this_thread::get_id()<br>              &lt;&lt; â€œ enteredâ€ &lt;&lt; std::endl;<br>    a.doSth();<br>  });</p>
<p>  t.join();</p>
<p>  return 0;<br>}</p>
<pre><code></code></pre><p>01 A(0xc00720)<br>Thread: 02 entered<br>02 A(0xc02ee0)<br>02 ~A(0xc02ee0)<br>01 ~A(0xc00720)</p>
<pre><code># åä¸€ã€åŸå­æ“ä½œ
å‰é¢æˆ‘ä»¬è®²äº†C++11ä¸‹çš„å¤šçº¿ç¨‹åŠç›¸å…³æ“ä½œï¼Œè¿™äº›æ“ä½œåœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹åº”è¯¥å¤Ÿç”¨äº†ã€‚ä½†åœ¨æŸäº›æç«¯åœºåˆï¼Œå¦‚éœ€è¦é«˜æ€§èƒ½çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€äº›æ›´é«˜æ•ˆçš„åŒæ­¥æ‰‹æ®µã€‚æœ¬èŠ‚ä»‹ç»çš„åŸå­æ“ä½œæ˜¯ä¸€ç§lock freeçš„æ“ä½œï¼Œä¸éœ€è¦åŒæ­¥é”ï¼Œå…·æœ‰å¾ˆé«˜çš„æ€§èƒ½ã€‚åœ¨åŒ–å­¦ä¸­åŸå­ä¸æ˜¯å¯åˆ†å‰²çš„æœ€å°å•ä½ï¼Œå¼•ç”³åˆ°ç¼–ç¨‹ä¸­ï¼ŒåŸå­æ“ä½œæ˜¯ä¸å¯æ‰“æ–­çš„æœ€ä½ç²’åº¦æ“ä½œï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚C++11ä¸­åŸå­ç±»æä¾›çš„æˆå‘˜å‡½æ•°éƒ½æ˜¯åŸå­çš„ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
åŸå­æ“ä½œä¸­æœ€ç®€å•çš„è«è¿‡äºatomic_flagï¼Œåªæœ‰ä¸¤ç§æ“ä½œï¼štest and setã€clearã€‚æˆ‘ä»¬çš„åŸå­æ“ä½œå°±ä»è¿™ç§ç±»å‹å¼€å§‹ã€‚
## 11.1 std::atomic_flag
C++11ä¸­æ‰€æœ‰çš„åŸå­ç±»éƒ½æ˜¯ä¸å…è®¸æ‹·è´ã€ä¸å…è®¸Moveçš„ï¼Œatomic_flagä¹Ÿä¸ä¾‹å¤–ã€‚atomic_flagé¡¾åæ€è®®ï¼Œæä¾›äº†æ ‡å¿—çš„ç®¡ç†ï¼Œæ ‡å¿—æœ‰ä¸‰ç§çŠ¶æ€ï¼šclearã€setå’Œæœªåˆå§‹åŒ–çŠ¶æ€ã€‚
### 11.1.1  atomic_flagå®ä¾‹åŒ–
ç¼ºçœæƒ…å†µä¸‹atomic_flagå¤„äºæœªåˆå§‹åŒ–çŠ¶æ€ã€‚é™¤éåˆå§‹åŒ–æ—¶ä½¿ç”¨äº†ATOMIC_FLAG_INITå®ï¼Œåˆ™æ­¤æ—¶atomic_flagå¤„äºclearçŠ¶æ€ã€‚
### 11.1.2 std::atomic_flag::clear
è°ƒç”¨è¯¥å‡½æ•°å°†ä¼šæŠŠatomic_flagç½®ä¸ºclearçŠ¶æ€ã€‚clearçŠ¶æ€æ‚¨å¯ä»¥ç†è§£ä¸ºboolç±»å‹çš„falseï¼ŒsetçŠ¶æ€å¯ç†è§£ä¸ºtrueçŠ¶æ€ã€‚clearå‡½æ•°æ²¡æœ‰ä»»ä½•è¿”å›å€¼:
```c
void clear(memory_order m = memory_order_seq_cst) volatile noexcept;
void clear(memory_order m = memory_order_seq_cst) noexcept;</code></pre><p>å¯¹äºmemory_orderæˆ‘ä»¬ä¼šåœ¨åé¢çš„ç« èŠ‚ä¸­è¯¦ç»†ä»‹ç»å®ƒï¼Œç°åœ¨å…ˆåˆ—å‡ºå…¶å–å€¼åŠç®€å•é‡Šä¹‰</p>
<table>
<thead>
<tr>
<th align="center">åºå·</th>
<th align="center">å€¼</th>
<th align="center">æ„ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">memory_order_relaxed</td>
<td align="center">å®½æ¾æ¨¡å‹ï¼Œä¸å¯¹æ‰§è¡Œé¡ºåºåšä¿è¯</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">memory_order_consume</td>
<td align="center">å½“å‰çº¿ç¨‹ä¸­,æ»¡è¶³happens-beforeåŸåˆ™ã€‚å½“å‰çº¿ç¨‹ä¸­è¯¥åŸå­çš„æ‰€æœ‰åç»­æ“ä½œ,å¿…é¡»åœ¨æœ¬æ¡æ“ä½œå®Œæˆä¹‹åæ‰§è¡Œ</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">memory_order_acquire</td>
<td align="center">å½“å‰çº¿ç¨‹ä¸­,è¯»æ“ä½œæ»¡è¶³happens-beforeåŸåˆ™ã€‚æ‰€æœ‰åç»­çš„è¯»æ“ä½œå¿…é¡»åœ¨æœ¬æ“ä½œå®Œæˆåæ‰§è¡Œ</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">memory_order_release</td>
<td align="center">å½“å‰çº¿ç¨‹ä¸­,å†™æ“ä½œæ»¡è¶³happens-beforeåŸåˆ™ã€‚æ‰€æœ‰åç»­çš„å†™æ“ä½œå¿…é¡»åœ¨æœ¬æ“ä½œå®Œæˆåæ‰§è¡Œ</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">memory_order_acq_rel</td>
<td align="center">å½“å‰çº¿ç¨‹ä¸­ï¼ŒåŒæ—¶æ»¡è¶³memory_order_acquireå’Œmemory_order_release</td>
</tr>
<tr>
<td align="center">6</td>
<td align="center">memory_order_seq_cst</td>
<td align="center">æœ€å¼ºçº¦æŸã€‚å…¨éƒ¨è¯»å†™éƒ½æŒ‰é¡ºåºæ‰§è¡Œ</td>
</tr>
<tr>
<td align="center">### 11.1.3 test_and_set</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">è¯¥å‡½æ•°ä¼šæ£€æµ‹flagæ˜¯å¦å¤„äºsetçŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™å°†å…¶è®¾ç½®ä¸ºsetçŠ¶æ€ï¼Œå¹¶è¿”å›falseï¼›å¦åˆ™è¿”å›trueã€‚</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><a href="https://en.wikipedia.org/wiki/Test-and-set" target="_blank" rel="noopener">test_and_set</a>æ˜¯å…¸å‹çš„<em>read-modify-write(RMW)</em>æ¨¡å‹ï¼Œä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹åªè¢«è®¾ç½®ä¸€æ¬¡ã€‚ä¸‹é¢ä»£ç é€šè¿‡10ä¸ªçº¿ç¨‹ï¼Œæ¨¡æ‹Ÿäº†ä¸€ä¸ªè®¡æ•°ç¨‹åºï¼Œç¬¬ä¸€ä¸ªå®Œæˆè®¡æ•°çš„ä¼šæ‰“å°â€winâ€ã€‚</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">```c</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">#include <atomic>    // atomic_flag</atomic></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">#include <iostream>  // std::cout, std::endl</iostream></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">#include <list>      // std::list</list></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">#include <thread>    // std::thread</thread></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
<p>void race(std::atomic_flag &amp;af, int id, int n) {<br>    for (int i = 0; i &lt; n; i++) {<br>    }<br>    // ç¬¬ä¸€ä¸ªå®Œæˆè®¡æ•°çš„æ‰“å°ï¼šWin<br>    if (!af.test_and_set()) {<br>        printf(â€œ%s[%d] win!!!\nâ€, <strong>FUNCTION</strong>, id);<br>    }<br>}</p>
<p>int main() {<br>    std::atomic_flag af = ATOMIC_FLAG_INIT;</p>
<pre><code>std::list&lt;std::thread&gt; lstThread;
for (int i = 0; i &lt; 10; i++) {
    lstThread.emplace_back(race, std::ref(af), i + 1, 5000 * 10000);
}

for (std::thread &amp;thr : lstThread) {
    thr.join();
}

return 0;</code></pre><p>}</p>
<pre><code></code></pre><p>race[7] win!!!</p>
<pre><code>## 11.2 std::atomic&lt;T&gt;
std::atomicæ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œå®ƒå®šä¹‰äº†ä¸€äº›atomicåº”è¯¥å…·æœ‰çš„é€šç”¨æ“ä½œï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹:
### 11.2.1 is_lock_free
```c
bool is_lock_free() const noexcept;
bool is_lock_free() const volatile noexcept;</code></pre><p>atomicæ˜¯å¦æ— é”æ“ä½œã€‚å¦‚æœæ˜¯ï¼Œåˆ™åœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®è¯¥å¯¹è±¡æ—¶ä¸ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡(å¯èƒ½ä½¿ç”¨æŸç§äº‹åŠ¡å†…å­˜transactional memoryæ–¹æ³•å®ç°lock-freeçš„ç‰¹æ€§)ã€‚<br>äº‹å®ä¸Šè¯¥å‡½æ•°å¯ä»¥åšä¸ºä¸€ä¸ªé™æ€å‡½æ•°ã€‚æ‰€æœ‰æŒ‡å®šç›¸åŒç±»å‹Tçš„atomicå®ä¾‹çš„is_lock_freeå‡½æ•°éƒ½ä¼šè¿”å›ç›¸åŒå€¼ã€‚</p>
<h3 id="11-2-2-store"><a href="#11-2-2-store" class="headerlink" title="11.2.2 store"></a>11.2.2 store</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">store</span><span class="token punctuation">(</span>T desr<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">store</span><span class="token punctuation">(</span>T desr<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
T operator<span class="token operator">=</span><span class="token punctuation">(</span>T d<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>
T operator<span class="token operator">=</span><span class="token punctuation">(</span>T d<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>èµ‹å€¼æ“ä½œã€‚operator=å®é™…ä¸Šå†…éƒ¨è°ƒç”¨äº†storeï¼Œå¹¶è¿”å›dã€‚</p>
<pre class="line-numbers language-c"><code class="language-c">T operator<span class="token operator">=</span><span class="token punctuation">(</span>T d<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexpect <span class="token punctuation">{</span>
    <span class="token function">store</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> d<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ³¨ï¼šæœ‰äº›ç¼–è¯‘å™¨ï¼Œåœ¨å®ç°storeæ—¶é™å®šmåªèƒ½å–ä»¥ä¸‹ä¸‰ä¸ªå€¼ï¼šmemory_order_consumeï¼Œmemory_order_acquireï¼Œmemory_order_acq_relã€‚</p>
<h3 id="11-2-3-load"><a href="#11-2-3-load" class="headerlink" title="11.2.3 load"></a>11.2.3 load</h3><pre class="line-numbers language-c"><code class="language-c">T <span class="token function">load</span><span class="token punctuation">(</span>memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
T <span class="token function">load</span><span class="token punctuation">(</span>memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> <span class="token keyword">const</span> noexcept<span class="token punctuation">;</span>
operator <span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
operator <span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> noexcept<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯»å–ï¼ŒåŠ è½½å¹¶è¿”å›å˜é‡çš„å€¼ã€‚operator Tæ˜¯loadçš„ç®€åŒ–ç‰ˆï¼Œå†…éƒ¨è°ƒç”¨çš„æ˜¯load(memory_order_seq_cst)å½¢å¼ã€‚</p>
<h3 id="11-2-4-exchange"><a href="#11-2-4-exchange" class="headerlink" title="11.2.4 exchange"></a>11.2.4 exchange</h3><pre class="line-numbers language-c"><code class="language-c">T <span class="token function">exchange</span><span class="token punctuation">(</span>T desr<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
T <span class="token function">exchange</span><span class="token punctuation">(</span>T desr<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>äº¤æ¢ï¼Œèµ‹å€¼åè¿”å›å˜é‡èµ‹å€¼å‰çš„å€¼ã€‚exchangeä¹Ÿç§°ä¸ºread-modify-writeæ“ä½œã€‚</p>
<h3 id="11-2-5-compare-exchange-weak"><a href="#11-2-5-compare-exchange-weak" class="headerlink" title="11.2.5 compare_exchange_weak"></a>11.2.5 compare_exchange_weak</h3><pre class="line-numbers language-c"><code class="language-c">bool <span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> expect<span class="token punctuation">,</span> T desr<span class="token punctuation">,</span> memory_order s<span class="token punctuation">,</span> memory_order f<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
bool <span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> expect<span class="token punctuation">,</span> T desr<span class="token punctuation">,</span> memory_order s<span class="token punctuation">,</span> memory_order f<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>
bool <span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> expect<span class="token punctuation">,</span> T desr<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
bool <span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> expect<span class="token punctuation">,</span> T desr<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥å‡½æ•°ç›´æ¥æ¯”è¾ƒåŸå­å¯¹è±¡æ‰€å°è£…çš„å€¼ä¸expectçš„ç‰©ç†å†…å®¹ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯¹è±¡çš„æ¯”è¾ƒæ“ä½œåœ¨ä½¿ç”¨ operator==() åˆ¤æ–­æ—¶ç›¸ç­‰ï¼Œä½† compare_exchange_weak åˆ¤æ–­æ—¶å´å¯èƒ½å¤±è´¥ï¼Œå› ä¸ºå¯¹è±¡åº•å±‚çš„ç‰©ç†å†…å®¹ä¸­å¯èƒ½å­˜åœ¨ä½å¯¹é½æˆ–å…¶ä»–é€»è¾‘è¡¨ç¤ºç›¸åŒä½†æ˜¯ç‰©ç†è¡¨ç¤ºä¸åŒçš„å€¼(æ¯”å¦‚ true å’Œ 5ï¼Œå®ƒä»¬åœ¨é€»è¾‘ä¸Šéƒ½è¡¨ç¤ºâ€çœŸâ€ï¼Œä½†åœ¨ç‰©ç†ä¸Šä¸¤è€…çš„è¡¨ç¤ºå¹¶ä¸ç›¸åŒ)ã€‚<br>ä¸strongç‰ˆæœ¬ä¸åŒï¼Œweakç‰ˆå…è®¸è¿”å›ä¼ªfalseï¼Œå³ä½¿åŸå­å¯¹è±¡æ‰€å°è£…çš„å€¼ä¸expectçš„ç‰©ç†å†…å®¹ç›¸åŒï¼Œä¹Ÿä»ç„¶è¿”å›falseã€‚ä½†å®ƒåœ¨æŸäº›å¹³å°ä¸‹ä¼šå–å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œåœ¨æŸäº›å¾ªç¯ç®—æ³•ä¸­è¿™ç§è¡Œä¸ºä¹Ÿæ˜¯å¯æ¥å—çš„ã€‚å¯¹äºéå¾ªç¯ç®—æ³•å»ºè®®ä½¿ç”¨compare_exchange_strongã€‚</p>
<h3 id="11-2-6-compare-exchange-strong"><a href="#11-2-6-compare-exchange-strong" class="headerlink" title="11.2.6 compare_exchange_strong"></a>11.2.6 compare_exchange_strong</h3><pre class="line-numbers language-c"><code class="language-c">bool <span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> expect<span class="token punctuation">,</span> T desr<span class="token punctuation">,</span> memory_order s<span class="token punctuation">,</span> memory_order f<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
bool <span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> expect<span class="token punctuation">,</span> T desr<span class="token punctuation">,</span> memory_order s<span class="token punctuation">,</span> memory_order f<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>
bool <span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> expect<span class="token punctuation">,</span> T desr<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
bool <span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> expc<span class="token punctuation">,</span> T desr<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>compare_exchangeçš„strongç‰ˆæœ¬ï¼Œè¿›è¡Œcompareæ—¶ï¼Œä¸weakç‰ˆä¸€æ ·ï¼Œéƒ½æ˜¯æ¯”è¾ƒçš„ç‰©ç†å†…å®¹ã€‚ä¸weakç‰ˆä¸åŒçš„æ˜¯ï¼Œstrongç‰ˆæœ¬ä¸ä¼šè¿”å›ä¼ªfalseã€‚å³ï¼šåŸå­å¯¹è±¡æ‰€å°è£…çš„å€¼å¦‚æœä¸expectåœ¨ç‰©ç†å†…å®¹ä¸Šç›¸åŒï¼Œstrongç‰ˆæœ¬ä¸€å®šä¼šè¿”å›trueã€‚å…¶æ‰€ä»˜å‡ºçš„ä»£ä»·æ˜¯ï¼šåœ¨æŸäº›éœ€è¦å¾ªç¯æ£€æµ‹çš„ç®—æ³•ï¼Œæˆ–æŸäº›å¹³å°ä¸‹ï¼Œå…¶æ€§èƒ½è¾ƒcompare_exchange_weakè¦å·®ã€‚ä½†å¯¹äºæŸäº›ä¸éœ€è¦é‡‡ç”¨å¾ªç¯æ£€æµ‹çš„ç®—æ³•è€Œè¨€, é€šå¸¸é‡‡ç”¨compare_exchange_strong æ›´å¥½ã€‚</p>
<h2 id="11-3-std-atomicç‰¹åŒ–"><a href="#11-3-std-atomicç‰¹åŒ–" class="headerlink" title="11.3 std::atomicç‰¹åŒ–"></a>11.3 std::atomicç‰¹åŒ–</h2><p>æˆ‘çŸ¥é“è®¡ç®—æ“…é•¿å¤„ç†æ•´æ•°ä»¥åŠæŒ‡é’ˆï¼Œå¹¶ä¸”X86æ¶æ„çš„CPUè¿˜æä¾›äº†æŒ‡ä»¤çº§çš„CASæ“ä½œã€‚C++11ä¸ºäº†å……åˆ†å‘æŒ¥è®¡ç®—çš„ç‰¹é•¿ï¼Œé’ˆå¯¹éæµ®ç‚¹æ•°å€¼(std::atmoic<integral>)åŠæŒ‡é’ˆ(std::atomic&lt;T*&gt;)è¿›è¡Œäº†ç‰¹åŒ–ï¼Œä»¥æé«˜åŸå­æ“ä½œçš„æ€§èƒ½ã€‚ç‰¹åŒ–åçš„atomicåœ¨é€šç”¨æ“ä½œçš„åŸºç¡€ä¸Šï¼Œè¿˜æä¾›äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½ã€‚</integral></p>
<h3 id="11-3-1-fetch-add"><a href="#11-3-1-fetch-add" class="headerlink" title="11.3.1 fetch_add"></a>11.3.1 fetch_add</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// T is integral</span>
T <span class="token function">fetch_add</span><span class="token punctuation">(</span>T v<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
T <span class="token function">fetch_add</span><span class="token punctuation">(</span>T v<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// T is pointer</span>
T <span class="token function">fetch_add</span><span class="token punctuation">(</span>ptrdiff_t v<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
T <span class="token function">fetch_add</span><span class="token punctuation">(</span>ptrdiff_t v<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥å‡½æ•°å°†åŸå­å¯¹è±¡å°è£…çš„å€¼åŠ ä¸Švï¼ŒåŒæ—¶è¿”å›åŸå­å¯¹è±¡çš„æ—§å€¼ã€‚å…¶åŠŸèƒ½ç”¨ä¼ªä»£ç è¡¨ç¤ºä¸ºï¼š</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">auto</span> old <span class="token operator">=</span> contained
contained <span class="token operator">+</span><span class="token operator">=</span> v
<span class="token keyword">return</span> old<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>å…¶ä¸­containedä¸ºåŸå­å¯¹è±¡å°è£…å€¼ï¼Œæœ¬æ–‡åé¢å‡ä½¿ç”¨containedä»£è¡¨è¯¥å€¼ã€‚æ³¨ï¼š ä»¥ä¸Šæ˜¯ä¸ºäº†ä¾¿äºç†è§£çš„ä¼ªä»£ç ï¼Œå®é™…å®ç°æ˜¯åŸå­çš„ä¸å¯æ‹†åˆ†çš„ã€‚</p>
<h3 id="11-3-2-fetch-sub"><a href="#11-3-2-fetch-sub" class="headerlink" title="11.3.2 fetch_sub"></a>11.3.2 fetch_sub</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// T is integral</span>
T <span class="token function">fetch_sub</span><span class="token punctuation">(</span>T v<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
T <span class="token function">fetch_sub</span><span class="token punctuation">(</span>T v<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// T is pointer</span>
T <span class="token function">fetch_sub</span><span class="token punctuation">(</span>ptrdiff_t v<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
T <span class="token function">fetch_sub</span><span class="token punctuation">(</span>ptrdiff_t v<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥å‡½æ•°å°†åŸå­å¯¹è±¡å°è£…çš„å€¼å‡å»vï¼ŒåŒæ—¶è¿”å›åŸå­å¯¹è±¡çš„æ—§å€¼ã€‚å…¶åŠŸèƒ½ç”¨ä¼ªä»£ç è¡¨ç¤ºä¸ºï¼š</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">auto</span> old <span class="token operator">=</span> contained
contained <span class="token operator">-</span><span class="token operator">=</span> v
<span class="token keyword">return</span> old<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="11-3-3-â€“"><a href="#11-3-3-â€“" class="headerlink" title="11.3.3 ++, â€“, +=, -="></a>11.3.3 ++, â€“, +=, -=</h3><p>ä¸ç®¡æ˜¯åŸºäºæ•´æ•°çš„ç‰¹åŒ–ï¼Œè¿˜æ˜¯æŒ‡é’ˆç‰¹åŒ–ï¼Œatomicå‡æ”¯æŒè¿™å››ç§æ“ä½œã€‚å…¶ç”¨æ³•ä¸æœªå°è£…æ—¶ä¸€æ ·ï¼Œæ­¤å¤„å°±ä¸ä¸€ä¸€åˆ—ä¸¾å…¶å‡½æ•°åŸå‹äº†ã€‚</p>
<h2 id="11-4-ç‹¬å±äºæ•°å€¼å‹ç‰¹åŒ–çš„åŸå­æ“ä½œ-ä½æ“ä½œ"><a href="#11-4-ç‹¬å±äºæ•°å€¼å‹ç‰¹åŒ–çš„åŸå­æ“ä½œ-ä½æ“ä½œ" class="headerlink" title="11.4 ç‹¬å±äºæ•°å€¼å‹ç‰¹åŒ–çš„åŸå­æ“ä½œ - ä½æ“ä½œ"></a>11.4 ç‹¬å±äºæ•°å€¼å‹ç‰¹åŒ–çš„åŸå­æ“ä½œ - ä½æ“ä½œ</h2><h3 id="11-4-1-fetch-andï¼Œfetch-orï¼Œfetch-xor"><a href="#11-4-1-fetch-andï¼Œfetch-orï¼Œfetch-xor" class="headerlink" title="11.4.1 fetch_andï¼Œfetch_orï¼Œfetch_xor"></a>11.4.1 fetch_andï¼Œfetch_orï¼Œfetch_xor</h3><p>ä½æ“ä½œï¼Œå°†containedæŒ‰æŒ‡å®šæ–¹å¼è¿›è¡Œä½æ“ä½œï¼Œå¹¶è¿”å›containedçš„æ—§å€¼ã€‚</p>
<pre class="line-numbers language-c"><code class="language-c">integral <span class="token function">fetch_and</span><span class="token punctuation">(</span>integral v<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
integral <span class="token function">fetch_and</span><span class="token punctuation">(</span>integral v<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>
integral <span class="token function">fetch_or</span><span class="token punctuation">(</span>integral v<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
integral <span class="token function">fetch_or</span><span class="token punctuation">(</span>integral v<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span>
integral <span class="token function">fetch_xor</span><span class="token punctuation">(</span>integral v<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept<span class="token punctuation">;</span>
integral <span class="token function">fetch_xor</span><span class="token punctuation">(</span>integral v<span class="token punctuation">,</span> memory_order m <span class="token operator">=</span> memory_order_seq_cst<span class="token punctuation">)</span> noexcept<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»¥xorä¸ºä¾‹ï¼Œå…¶æ“ä½œç›¸å½“äº</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">auto</span> old <span class="token operator">=</span> contained
contained <span class="token operator">^</span><span class="token operator">=</span> v
<span class="token keyword">return</span> old<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="11-4-2-operator-amp-ï¼Œoperator-ï¼Œoperator"><a href="#11-4-2-operator-amp-ï¼Œoperator-ï¼Œoperator" class="headerlink" title="11.4.2 operator &amp;=ï¼Œoperator |=ï¼Œoperator ^="></a>11.4.2 operator &amp;=ï¼Œoperator |=ï¼Œoperator ^=</h2><p>ä¸ç›¸åº”çš„fetch_*æ“ä½œä¸åŒçš„æ˜¯ï¼Œoperatoræ“ä½œè¿”å›çš„æ˜¯æ–°å€¼:</p>
<pre class="line-numbers language-c"><code class="language-c">T operator <span class="token operator">&amp;</span><span class="token operator">=</span><span class="token punctuation">(</span>T v<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">fetch_and</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">&amp;</span> v<span class="token punctuation">;</span><span class="token punctuation">}</span>
T operator <span class="token operator">&amp;</span><span class="token operator">=</span><span class="token punctuation">(</span>T v<span class="token punctuation">)</span> noexcept <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">fetch_and</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">&amp;</span> v<span class="token punctuation">;</span><span class="token punctuation">}</span>
T operator <span class="token operator">|</span><span class="token operator">=</span><span class="token punctuation">(</span>T v<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">fetch_or</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">|</span> v<span class="token punctuation">;</span><span class="token punctuation">}</span>
T operator <span class="token operator">|</span><span class="token operator">=</span><span class="token punctuation">(</span>T v<span class="token punctuation">)</span> noexcept <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">fetch_or</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">|</span> v<span class="token punctuation">;</span><span class="token punctuation">}</span>
T operator <span class="token operator">^</span><span class="token operator">=</span><span class="token punctuation">(</span>T v<span class="token punctuation">)</span> <span class="token keyword">volatile</span> noexcept <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">fetch_xor</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">^</span> v<span class="token punctuation">;</span><span class="token punctuation">}</span>
T operator <span class="token operator">^</span><span class="token operator">=</span><span class="token punctuation">(</span>T v<span class="token punctuation">)</span> noexcept <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">fetch_xor</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">^</span> v<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="11-5-std-atomicçš„é™åˆ¶ï¼štrivially-copyable"><a href="#11-5-std-atomicçš„é™åˆ¶ï¼štrivially-copyable" class="headerlink" title="11.5  std::atomicçš„é™åˆ¶ï¼štrivially copyable"></a>11.5  std::atomicçš„é™åˆ¶ï¼štrivially copyable</h2><p>ä¸Šé¢æˆ‘ä»¬æåˆ°std::atomicæä¾›äº†é€šç”¨æ“ä½œï¼Œå…¶å®è¿™äº›æ“ä½œå¯ä»¥åº”ç”¨åˆ°æ‰€æœ‰trivially copyableçš„ç±»å‹ã€‚trivially copyableåœ¨cppreferenceä¸­æ–‡ç«™è¢«è¯‘ä¸ºâ€œå¯å¹³å‡¡å¤åˆ¶â€ã€‚ç½‘ä¸Šä¹Ÿæœ‰äººè¯‘ä½œæ‹·è´ä¸å˜ã€‚ä¸€ä¸ªç±»å‹å¦‚æœæ˜¯trivially copyableï¼Œåˆ™ä½¿ç”¨memcpyè¿™ç§æ–¹å¼æŠŠå®ƒçš„æ•°æ®ä»ä¸€ä¸ªåœ°æ–¹æ‹·è´å‡ºæ¥ä¼šå¾—åˆ°ç›¸åŒçš„ç»“æœã€‚å› æ­¤æœ¬æ–‡ä½¿ç”¨æ‹·è´ä¸å˜è¿™ä¸ªä¸­æ–‡ç¿»è¯‘ï¼Œè¯·å¤§å®¶ä¸è¦çº ç»“ä¸­æ–‡ç¿»è¯‘ï¼Œæ˜ç™½æœ¬æ–‡æ‰€è¡¨è¾¾çš„æ„æ€å³å¯ã€‚ç¼–è¯‘å™¨å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»å‹æ˜¯å¦trivially copyableå‘¢ï¼ŸC++æ ‡å‡†æŠŠtrivialç±»å‹å®šä¹‰å¦‚ä¸‹ï¼Œä¸€ä¸ªæ‹·è´ä¸å˜(trivially copyable)ç±»å‹æ˜¯æŒ‡ï¼š</p>
<ul>
<li><p>æ²¡æœ‰non-trivial çš„æ‹·è´æ„é€ å‡½æ•°</p>
</li>
<li><p>æ²¡æœ‰non-trivialçš„moveæ„é€ å‡½æ•°</p>
</li>
<li><p>æ²¡æœ‰non-trivialçš„èµ‹å€¼æ“ä½œç¬¦</p>
</li>
<li><p>æ²¡æœ‰non-trivialçš„moveèµ‹å€¼æ“ä½œç¬¦<br>æœ‰ä¸€ä¸ªtrivialçš„ææ„å‡½æ•°<br>ä¸€ä¸ªtrivial classç±»å‹æ˜¯æŒ‡æœ‰ä¸€ä¸ªtrivialç±»å‹çš„é»˜è®¤æ„é€ å‡½æ•°ï¼Œè€Œä¸”æ˜¯æ‹·è´ä¸å˜çš„(trivially copyable)çš„classã€‚ç‰¹åˆ«æ³¨æ„ï¼Œæ‹·è´ä¸å˜ç±»å‹å’Œtrivialç±»å‹éƒ½ä¸èƒ½æœ‰è™šæœºåˆ¶ã€‚é‚£ä¹ˆtrivialå’Œnon-trivialç±»å‹åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œç»™å‡ºä¸€ä¸ªéå®˜æ–¹ã€ä¸ä¸¥è°¨çš„åˆ¤æ–­æ–¹å¼ï¼Œæ–¹ä¾¿å¤§å®¶å¯¹trivially copyableæœ‰ä¸€ä¸ªç›´è§‚çš„è®¤è¯†ã€‚ä¸€ä¸ªtrivial copyableç±»åœ¨å››ä¸ªç‚¹ä¸Šæ²¡æœ‰è‡ªå®šä¹‰åŠ¨ä½œï¼Œä¹Ÿæ²¡æœ‰ç¼–è¯‘å™¨åŠ å…¥çš„é¢å¤–åŠ¨ä½œ(å¦‚è™šæŒ‡é’ˆåˆå§‹åŒ–å°±å±é¢å¤–åŠ¨ä½œ)ï¼Œè¿™å››ä¸ªç‚¹æ˜¯:</p>
</li>
<li><p>ç¼ºçœæ„é€ ã€‚ç±»å¿…é¡»æ”¯æŒç¼ºçœæ„é€ ï¼ŒåŒæ—¶ç±»çš„éé™æ€æˆå‘˜ä¹Ÿä¸èƒ½æœ‰è‡ªå®šä¹‰æˆ–ç¼–è¯‘å™¨åŠ å…¥çš„é¢å¤–åŠ¨ä½œï¼Œå¦åˆ™ç¼–è¯‘å™¨åŠ¿å¿…ä¼šéšå¼æ’å…¥é¢å¤–åŠ¨ä½œæ¥åˆå§‹åŒ–éé™æ€æˆå‘˜ã€‚</p>
</li>
<li><p>æ‹·è´æ„é€ ã€æ‹·è´èµ‹å€¼</p>
</li>
<li><p>moveæ„é€ ã€moveèµ‹å€¼</p>
</li>
<li><p>ææ„<br>ä¸ºäº†åŠ æ·±ç†è§£ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸‹é¢çš„ä¾‹å­(æ‰€æœ‰çš„ç±»éƒ½æ˜¯trivialçš„)ï¼š</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// ç©ºç±»</span>
<span class="token keyword">struct</span> A1 <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<p>// æˆå‘˜å˜é‡æ˜¯trivialçš„<br>struct A2 {<br>    int x;<br>};</p>
<p>// åŸºç±»æ˜¯trivialçš„<br>struct A3 : A2 {<br>    // éç”¨æˆ·è‡ªå®šä¹‰çš„æ„é€ å‡½æ•°(ä½¿ç”¨ç¼–è¯‘å™¨æä¾›çš„defaultæ„é€ )<br>    A3() = default;<br>    int y;<br>};</p>
<p>struct A4 {<br>    int a;<br>private: // å¯¹é˜²é—®é™å®šç¬¦æ²¡æœ‰è¦æ±‚ï¼ŒA4ä»ç„¶æ˜¯trivialçš„<br>    int b;<br>};</p>
<p>struct A5 {<br>    A1 a;<br>    A2 b;<br>    A3 c;<br>    A4 d;<br>};</p>
<p>struct A6 {<br>    A2 a[16];<br>};</p>
<p>struct A7 {<br>    A6 c;<br>    void f(); // æ™®é€šæˆå‘˜å‡½æ•°æ˜¯å…è®¸çš„<br>};</p>
<p>struct A8 {<br>     int x;<br>    // å¯¹é™æ€æˆå‘˜æ— è¦æ±‚(std::stringæ˜¯non-trivialçš„)<br>     static std::string y;<br>};</p>
<p>struct A9 {<br>    // éç”¨æˆ·è‡ªå®šä¹‰<br>    A9() = default;<br>    // æ™®é€šæ„é€ å‡½æ•°æ˜¯å¯ä»¥çš„(å‰ææ˜¯æˆ‘ä»¬å·²ç»æœ‰äº†éå®šä¹‰çš„ç¼ºçœæ„é€ å‡½æ•°)<br>    A9(int x) : x(x) {};<br>    int x;<br>};</p>
<pre><code>è€Œä¸‹é¢è¿™äº›ç±»å‹éƒ½æ˜¯non-trivialçš„

```c
struct B {
    // æœ‰è™šå‡½æ•°(ç¼–è¯‘å™¨ä¼šéšå¼ç”Ÿæˆç¼ºçœæ„é€ ï¼ŒåŒæ—¶ä¼šåˆå§‹åŒ–è™šå‡½æ•°æŒ‡é’ˆ)
    virtual f();
};

struct B2 {
    // ç”¨æˆ·è‡ªå®šä¹‰ç¼ºçœæ„é€ å‡½æ•°
    B2() : z(42) {}
    int z;
};

struct B3 {
    B3();
    int w;
};
// è™½ç„¶ä½¿ç”¨äº†defaultï¼Œä½†åœ¨ç¼ºçœæ„é€ å£°æ˜å¤„æœªæŒ‡å®šï¼Œå› æ­¤è¢«åˆ¤æ–­ä¸ºnon-trivialçš„
NonTrivial3::NonTrivial3() = default;

struct B4 {
   // è™šææ„æ˜¯non-trivialçš„
    virtual ~B4();
};</code></pre><p>struct B {<br>    // æœ‰è™šå‡½æ•°(ç¼–è¯‘å™¨ä¼šéšå¼ç”Ÿæˆç¼ºçœæ„é€ ï¼ŒåŒæ—¶ä¼šåˆå§‹åŒ–è™šå‡½æ•°æŒ‡é’ˆ)<br>    virtual f();<br>};</p>
<p>struct B2 {<br>    // ç”¨æˆ·è‡ªå®šä¹‰ç¼ºçœæ„é€ å‡½æ•°<br>    B2() : z(42) {}<br>    int z;<br>};</p>
<p>STLåœ¨å…¶å¤´æ–‡ä»¶<type_traits>ä¸­å®šä¹‰äº†å¯¹trivially copyableç±»å‹çš„æ£€æµ‹ï¼š</type_traits></p>
<pre class="line-numbers language-c"><code class="language-c">template <span class="token operator">&lt;</span>typename T<span class="token operator">></span>
<span class="token keyword">struct</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>is_trivially_copyable<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>åˆ¤æ–­ç±»Aæ˜¯å¦trivially copyable:std::is_trivially_copyable<a>::valueï¼Œè¯¥å€¼æ˜¯ä¸€ä¸ªconst boolç±»å‹ï¼Œå¦‚æœä¸ºtrueåˆ™æ˜¯trivially copyableçš„ï¼Œå¦åˆ™ä¸æ˜¯ã€‚<br>å‚è€ƒé“¾æ¥ï¼š<br><a href="https://blog.csdn.net/coolwriter/article/details/79883253" target="_blank" rel="noopener">https://blog.csdn.net/coolwriter/article/details/79883253</a><br><a href="https://www.jianshu.com/p/dcce068ee32b" target="_blank" rel="noopener">https://www.jianshu.com/p/dcce068ee32b</a></a></p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
                 
                 <hr/>
                 

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fa fa-user">
                        æ–‡ç« ä½œè€…:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://purethought.cn" rel="external nofollow noreferrer">é™ˆå¾·å¼º</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fa fa-link">
                        æ–‡ç« é“¾æ¥:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://purethought.cn/9f089854.html">https://purethought.cn/9f089854.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fa fa-copyright">
                        ç‰ˆæƒå£°æ˜:
                    </i>
                </span>
                <span class="reprint-info">
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº
                    <a href="https://purethought.cn" target="_blank">é™ˆå¾·å¼º</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>å¤åˆ¶æˆåŠŸï¼Œè¯·éµå¾ªæœ¬æ–‡çš„è½¬è½½è§„åˆ™</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">æŸ¥çœ‹</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


            </div>         
        </div>
    </div>
    
    <!-- ä»£ç å—åŠŸèƒ½ä¾èµ– -->
    <script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>    
    <!-- ä»£ç è¯­è¨€ -->   
    <!-- <script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script> -->          
    <!-- ä»£ç å—å¤åˆ¶ -->   
    <script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
    <script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>      
    <!-- ä»£ç å—æ”¶ç¼© -->   
    <script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge ">                  
                <a href="/c54138a3.html" target="_blank">                 
                    <font color="#0e263f">
                        <i class="fa  fa-hand-o-left"></i>
                        ç¬”è®°æœ¬Ctrlé”®ä¸å¥½ç”¨
                    </font>                    
                </a>          
            </div>
        </div>
        


        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge " >
                <a href="/b4bfabf8.html" target="_blank">
                    <font color="#0e263f">
                        C++éšæœºæ•°
                        <i class="fa  fa-hand-o-right"></i>
                    </font>
                 </a>  
            </div>
        </div>
        
    </div>
</article>

    
        <style>
    #reward {
        /*margin: 40px 0;*/
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.6rem;
      
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
   <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red" >Â¥</a> 
  

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-times"></i></a>
            <h4 class="reward-title">æ‚¨çš„èµèµå°±æ˜¯æˆ‘çš„åŠ¨åŠ›^</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">æ”¯ä»˜å®</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">å¾® ä¿¡</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

    

    
        <div class="livere-card card" data-aos="fade-up">
    <!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
    <div id="lv-container" class="card-content" data-id="city" data-uid="MTAyMC80Njk3Mi8yMzQ3Mw==">
        <script type="text/javascript">
            (function (d, s) {
                let j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') {
                    return;
                }

                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScriptã€‚</noscript>
    </div>
    <!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
</div>
    
    
   <!-- 
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '6190f09c0ffe658707b5',
        clientSecret: '2798e16eeba573f49ce06d2da0595188699aac41',
        repo: 'cdqpt.github.io',
        owner: 'CdqPT',
        admin: "CdqPT",
        id: '2019-10-05T16-00-00',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
     -->

    

    

    

   <!-- <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>å¾®ä¿¡é‡Œç‚¹â€œå‘ç°â€->â€œæ‰«ä¸€æ‰«â€äºŒç»´ç ä¾¿å¯æŸ¥çœ‹åˆ†äº«ã€‚</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script> -->

</div>




    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
    
        <div class="toc-widget">
        
            <div class="toc-title" ><i class="fa fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="hidden">
                <div id="toc-content"></div>
            </div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. --><!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large ">    
        <i class="fa fa-th-large"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2'
        });
        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            i++;
            $(this).attr('href', '#' + tocHeading + (i));
            $(this).attr('navTo',  tocHeading + (i));    
        });
        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });
        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
        
        /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }
            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };
        // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(0);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(100);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    
</main>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
       <div class="col s12 m8 l8 copy-right">
             
               &copy;2018-2020 ALaDing
               &nbsp;
             Author:  <a href="https://purethought.cn/">é™ˆå¾·å¼º &nbsp  Email: 928277452@qq.com</a>

            
            
			
                <br>
                
                <span id="busuanzi_container_site_pv">
                    <i class="fa fa-heart-o"></i>
                    æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
                
                
                <span id="busuanzi_container_site_uv">
                    <i class="fa fa-users"></i>
                    æ¬¡,&nbsp;è®¿å®¢æ•° <span id="busuanzi_value_site_uv" class="white-color"></span> äºº.
                </span>
                       
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?147475454185ebcf440a27cc35e793ef";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>










                
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/CdqPT" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:928277452@qq.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=928277452" class="tooltipped" data-tooltip="QQè”ç³»æˆ‘: 928277452" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    
    <!-- Global site tag (gtag.js) - Google Analytics -->


 
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

   

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
<script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>

</html>
